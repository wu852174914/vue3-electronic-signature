(function(y,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],l):(y=typeof globalThis<"u"?globalThis:y||self,l(y.Vue3ElectronicSignature={},y.Vue))})(this,function(y,l){"use strict";var Ct=Object.defineProperty;var bt=(y,l,W)=>l in y?Ct(y,l,{enumerable:!0,configurable:!0,writable:!0,value:W}):y[l]=W;var P=(y,l,W)=>(bt(y,typeof l!="symbol"?l+"":l,W),W);function W(i,t){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}function H(i,t){return Math.atan2(t.y-i.y,t.x-i.x)}function L(i,t,a,n){const s=t||i,c=a||i,u=.2,h=H(s,c)*(n?1:-1),r=W(s,c)*u;return{x:i.x+Math.cos(h)*r,y:i.y+Math.sin(h)*r,time:i.time}}function U(i,t,a){if(!a.pressure.enabled)return a.strokeWidth;const n=W(i,t),s=t.time-i.time,c=s>0?n/s:0,u=Math.max(.1,Math.min(1,1-c*.01)),{min:h,max:r}=a.pressure;return h+(r-h)*u}function Ee(i,t,a){if(t.length<2)return;if(i.strokeStyle=a.strokeColor,i.lineCap="round",i.lineJoin="round",!a.smoothing||t.length<3){i.beginPath(),i.lineWidth=a.strokeWidth,i.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)i.lineTo(t[s].x,t[s].y);i.stroke();return}i.beginPath(),i.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length-1;s++){const c=t[s],u=t[s+1];a.pressure.enabled?i.lineWidth=U(t[s-1],c,a):i.lineWidth=a.strokeWidth;const h=L(c,t[s-1],u);i.quadraticCurveTo(h.x,h.y,c.x,c.y)}const n=t[t.length-1];i.lineTo(n.x,n.y),i.stroke()}function j(i){const{canvasSize:t,paths:a}=i;let n=`<svg width="${t.width}" height="${t.height}" xmlns="http://www.w3.org/2000/svg">`;return a.forEach(s=>{if(s.points.length<2)return;let c=`M ${s.points[0].x} ${s.points[0].y}`;for(let u=1;u<s.points.length;u++)c+=` L ${s.points[u].x} ${s.points[u].y}`;n+=`<path d="${c}" stroke="${s.strokeColor}" stroke-width="${s.strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),n+="</svg>",n}function G(i,t,a={format:"png"}){const{format:n,quality:s=.9,size:c,backgroundColor:u}=a;if(n==="svg")return j(t);const h=document.createElement("canvas"),r=h.getContext("2d");if(c){h.width=c.width,h.height=c.height;const g=c.width/i.width,v=c.height/i.height;r.scale(g,v)}else h.width=i.width,h.height=i.height;switch(u&&u!=="transparent"&&(r.fillStyle=u,r.fillRect(0,0,h.width,h.height)),r.drawImage(i,0,0),n){case"jpeg":return h.toDataURL("image/jpeg",s);case"base64":return h.toDataURL("image/png").split(",")[1];case"png":default:return h.toDataURL("image/png")}}function Q(i,t){return new Promise((a,n)=>{const s=new Image;s.onload=()=>{const c=i.getContext("2d");c.clearRect(0,0,i.width,i.height),c.drawImage(s,0,0,i.width,i.height),a()},s.onerror=n,s.src=t})}function N(i){return i.paths.length===0||i.paths.every(t=>t.points.length===0)}function V(i,t){return{paths:[],canvasSize:{width:i,height:t},timestamp:Date.now(),isEmpty:!0}}function E(i){return JSON.parse(JSON.stringify(i))}class K{constructor(t){P(this,"canvas");P(this,"ctx");P(this,"replayData",null);P(this,"state","idle");P(this,"currentTime",0);P(this,"speed",1);P(this,"animationId",null);P(this,"startTimestamp",0);P(this,"pausedTime",0);P(this,"options",{});P(this,"eventCallbacks",new Map);this.canvas=t,this.ctx=t.getContext("2d")}setReplayData(t,a={}){console.log("设置回放数据:",t),console.log("回放选项:",a),this.replayData=t,this.options={...a},this.speed=a.speed||t.speed||1,this.currentTime=a.startTime||0,this.state="idle",console.log("回放数据设置完成，路径数量:",t.paths.length),console.log("总时长:",t.totalDuration)}play(){if(console.log("播放方法调用，回放数据:",this.replayData),console.log("当前状态:",this.state),!this.replayData){console.error("没有回放数据，无法播放");return}if(this.replayData.totalDuration<=0){console.error("回放数据总时长为0，无法播放");return}if(this.replayData.paths.length===0){console.error("回放数据没有路径，无法播放");return}if(this.state==="playing"){console.log("已在播放中，忽略");return}this.state==="paused"?(console.log("从暂停状态恢复播放"),this.state="playing",this.startTimestamp=performance.now()-this.pausedTime,this.emit("replay-resume")):(console.log("开始新的播放"),this.state="playing",this.startTimestamp=performance.now(),this.pausedTime=0,this.currentTime=this.options.startTime||0,this.clearCanvas(),this.emit("replay-start")),this.animate()}pause(){this.state==="playing"&&(this.state="paused",this.pausedTime=performance.now()-this.startTimestamp,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.emit("replay-pause"))}stop(){this.state="stopped",this.currentTime=0,this.pausedTime=0,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clearCanvas(),this.emit("replay-stop")}seek(t){if(!this.replayData)return;const a=this.options.endTime||this.replayData.totalDuration;this.currentTime=Math.max(0,Math.min(t,a)),this.state==="playing"?this.startTimestamp=performance.now()-this.currentTime/this.speed:this.pausedTime=this.currentTime/this.speed,this.renderFrame(this.currentTime)}setSpeed(t){const a=this.state==="playing";a&&this.pause(),this.speed=Math.max(.1,Math.min(5,t)),this.emit("replay-speed-change",this.speed),a&&this.play()}getState(){return this.state}getCurrentTime(){return this.currentTime}getTotalDuration(){var t;return((t=this.replayData)==null?void 0:t.totalDuration)||0}getProgress(){const t=this.getTotalDuration();return t>0?this.currentTime/t:0}animate(){if(this.state!=="playing"||!this.replayData)return;const t=performance.now();this.currentTime=(t-this.startTimestamp)*this.speed;const a=this.options.endTime||this.replayData.totalDuration;if(this.currentTime>=a){this.currentTime=a,this.state="completed",this.renderFrame(this.currentTime),this.emit("replay-complete"),this.options.loop&&setTimeout(()=>{this.currentTime=this.options.startTime||0,this.play()},500);return}this.renderFrame(this.currentTime),this.emit("replay-progress",this.getProgress(),this.currentTime),this.animationId=requestAnimationFrame(()=>this.animate())}renderFrame(t){if(!this.replayData)return;this.clearCanvas();let a=!1;for(let n=0;n<this.replayData.paths.length;n++){const s=this.replayData.paths[n],c=s.startTime||0,u=s.endTime||c+(s.duration||0);if(t<c)break;if(t>=u){this.drawCompletePath(s),!a&&Math.abs(t-u)<32&&this.emit("replay-path-end",n,s);continue}a=!0;const h=Math.max(0,Math.min(1,(t-c)/Math.max(u-c,1)));h>0&&Math.abs(t-c)<32&&this.emit("replay-path-start",n,s),this.drawPartialPath(s,h);break}}drawCompletePath(t){if(t.points.length<2)return;const a=this.options.drawOptions||{strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,smoothing:!0,pressure:{enabled:!1,min:1,max:4}};this.drawPathWithSmoothAlgorithm(t.points,{...a,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth})}drawPartialPath(t,a){if(t.points.length<2)return;const n=t.startTime||0,s=t.duration||0,c=n+s*a,u=this.getPointsUpToTime(t.points,n,c);if(u.length<2)return;const h=this.options.drawOptions||{strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,smoothing:!0,pressure:{enabled:!1,min:1,max:4}};this.drawPathWithSmoothAlgorithm(u,{...h,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth})}getPointsUpToTime(t,a,n){const s=[];for(let c=0;c<t.length;c++){const u=t[c],h=a+(u.relativeTime||c*50);if(h<=n)s.push(u);else{if(c>0){const r=t[c-1],g=a+(r.relativeTime||(c-1)*50);if(g<=n){const v=(n-g)/(h-g),d={x:r.x+(u.x-r.x)*v,y:r.y+(u.y-r.y)*v,time:n,pressure:r.pressure?r.pressure+(u.pressure||r.pressure-r.pressure)*v:u.pressure};s.push(d)}}break}}return s}drawPathWithSmoothAlgorithm(t,a){if(t.length<2)return;if(this.ctx.strokeStyle=a.strokeColor,this.ctx.lineCap="round",this.ctx.lineJoin="round",!a.smoothing||t.length<3){this.ctx.beginPath(),this.ctx.lineWidth=a.strokeWidth,this.ctx.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)this.ctx.lineTo(t[s].x,t[s].y);this.ctx.stroke();return}this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length-1;s++){const c=t[s],u=t[s+1];this.ctx.lineWidth=a.strokeWidth;const h=this.getControlPoint(c,t[s-1],u);this.ctx.quadraticCurveTo(h.x,h.y,c.x,c.y)}const n=t[t.length-1];this.ctx.lineTo(n.x,n.y),this.ctx.stroke()}getControlPoint(t,a,n){const c={length:Math.sqrt(Math.pow(n.x-a.x,2)+Math.pow(n.y-a.y,2)),angle:Math.atan2(n.y-a.y,n.x-a.x)},u=c.angle+Math.PI,h=c.length*.2;return{x:t.x+Math.cos(u)*h,y:t.y+Math.sin(u)*h,time:t.time||0}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}on(t,a){this.eventCallbacks.has(t)||this.eventCallbacks.set(t,[]),this.eventCallbacks.get(t).push(a)}off(t,a){if(this.eventCallbacks.has(t))if(a){const n=this.eventCallbacks.get(t),s=n.indexOf(a);s>-1&&n.splice(s,1)}else this.eventCallbacks.delete(t)}emit(t,...a){const n=this.eventCallbacks.get(t);n&&n.forEach(s=>s(...a))}destroy(){this.stop(),this.eventCallbacks.clear(),this.replayData=null}}function Z(i){const t=i.paths.map(r=>{const g=r.points.map((d,C)=>{var b;let k;if(d.time&&r.points[0].time)k=d.time-r.points[0].time;else if(C===0)k=0;else{const I=r.points[C-1],x=Math.sqrt(Math.pow(d.x-I.x,2)+Math.pow(d.y-I.y,2))/100*1e3;k=(((b=g[C-1])==null?void 0:b.relativeTime)||0)+Math.max(x,16)}return{...d,relativeTime:k}}),v=g.length>0?g[g.length-1].relativeTime:0;return{...r,points:g,duration:v}}),a=[];for(let r=0;r<t.length;r++){const g=t[r];let v;if(r===0)v=0;else{const k=a[r-1],b=_e(i.paths[r-1].points,i.paths[r].points);v=k.endTime+b}const d=v+g.duration,C={...g,startTime:v,endTime:d};console.log(`路径 ${r}: 开始时间=${v}, 结束时间=${d}, 持续时间=${g.duration}`),a.push(C)}const n=a.length>0?a[a.length-1].endTime:0;console.log("回放数据生成完成:"),console.log("- 路径数量:",a.length),console.log("- 总时长:",n),console.log("- 路径详情:",a.map(r=>({startTime:r.startTime,endTime:r.endTime,duration:r.duration,pointCount:r.points.length})));const s=a.reduce((r,g)=>r+Ie(g.points),0),c=n>0?s/(n/1e3):0,u=a.slice(1).map((r,g)=>{const v=a[g];return r.startTime-v.endTime}),h=u.length>0?u.reduce((r,g)=>r+g,0)/u.length:0;return{paths:a,totalDuration:n,speed:1,metadata:{deviceType:Re(i),averageSpeed:c,totalDistance:s,averagePauseTime:h}}}function _e(i,t){if(i.length===0||t.length===0)return 200;const a=i[i.length-1],n=t[0];if(a.time&&n.time)return Math.max(n.time-a.time,50);const s=Math.sqrt(Math.pow(n.x-a.x,2)+Math.pow(n.y-a.y,2));return Math.min(Math.max(s*2,100),1e3)}function Re(i){const t=i.paths.reduce((c,u)=>c+u.points.length,0),a=i.paths.length;if(t===0)return"touch";const n=t/a;return n>20?"touch":n<10?"mouse":i.paths.some(c=>c.points.some(u=>u.pressure!==void 0))?"pen":"touch"}function Ie(i){let t=0;for(let a=1;a<i.length;a++){const n=i[a].x-i[a-1].x,s=i[a].y-i[a-1].y;t+=Math.sqrt(n*n+s*s)}return t}const J={pen:{name:"钢笔",description:"细线条，高精度，适合正式签名",strokeWidth:1.5,smoothing:!0,pressure:{enabled:!1,min:1,max:2},lineCap:"round",lineJoin:"round",recommendedColor:"#000080"},brush:{name:"毛笔",description:"压感变化，粗细不均，艺术感强",strokeWidth:4,smoothing:!0,pressure:{enabled:!0,min:2,max:8},lineCap:"round",lineJoin:"round",recommendedColor:"#2c3e50"},marker:{name:"马克笔",description:"粗线条，均匀宽度，醒目清晰",strokeWidth:5,smoothing:!0,pressure:{enabled:!1,min:4,max:6},lineCap:"round",lineJoin:"round",recommendedColor:"#e74c3c"},pencil:{name:"铅笔",description:"中等粗细，略有纹理，自然感强",strokeWidth:2,smoothing:!1,pressure:{enabled:!0,min:1.5,max:3},lineCap:"round",lineJoin:"round",recommendedColor:"#7f8c8d"},ballpoint:{name:"圆珠笔",description:"细线条，轻微变化，日常书写",strokeWidth:1,smoothing:!0,pressure:{enabled:!0,min:.8,max:1.5},lineCap:"round",lineJoin:"round",recommendedColor:"#3498db"}};function ee(i){return J[i]}function Ne(){return Object.entries(J).map(([i,t])=>({key:i,config:t}))}function te(i,t){const a=ee(i);return{strokeWidth:a.strokeWidth,smoothing:a.smoothing,pressure:a.pressure,lineCap:a.lineCap,lineJoin:a.lineJoin,strokeColor:t||a.recommendedColor||"#000000"}}const Ve=["width","height"],Oe={key:1,class:"signature-toolbar"},Ae=["disabled"],$e=["disabled"],Be=["disabled"],Je={key:2,class:"replay-controls"},Fe={class:"replay-buttons"},qe=["disabled"],ze={key:0},Ye={key:1},Xe=["disabled"],He={class:"replay-progress"},Le=["max","value","disabled"],Ue={class:"time-display"},je={class:"replay-speed"},Ge=l.defineComponent({__name:"ElectronicSignature",props:{showToolbar:{type:Boolean,default:!1},width:{default:"100%"},height:{default:300},penStyle:{default:"pen"},strokeColor:{default:"#000000"},strokeWidth:{default:2},backgroundColor:{default:"transparent"},disabled:{type:Boolean,default:!1},placeholder:{default:"请在此处签名"},smoothing:{type:Boolean,default:!0},pressureSensitive:{type:Boolean,default:!1},minStrokeWidth:{default:1},maxStrokeWidth:{default:4},borderStyle:{default:"1px solid #ddd"},borderRadius:{default:"4px"},replayMode:{type:Boolean},replayData:{},replayOptions:{}},emits:["signature-start","signature-drawing","signature-end","signature-clear","signature-undo","signature-redo","replay-start","replay-progress","replay-pause","replay-resume","replay-stop","replay-complete","replay-path-start","replay-path-end","replay-speed-change"],setup(i,{expose:t,emit:a}){const n=i,s=a,c=l.ref(),u=l.ref(!1),h=l.ref(null),r=l.ref(V(0,0)),g=l.ref([]),v=l.ref(-1),d=l.ref(null),C=l.ref(!1),k=l.ref("idle"),b=l.ref(0),I=l.ref(0),M=l.computed(()=>typeof n.width=="number"?n.width:800),x=l.computed(()=>typeof n.height=="number"?n.height:300),ot=l.computed(()=>({position:"relative",display:"inline-block",width:typeof n.width=="string"?n.width:`${n.width}px`,height:typeof n.height=="string"?n.height:`${n.height}px`})),it=l.computed(()=>({border:n.borderStyle,borderRadius:n.borderRadius,backgroundColor:n.backgroundColor,cursor:n.disabled?"not-allowed":"crosshair",display:"block",width:"100%",height:"100%"})),st=l.computed(()=>({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#999",fontSize:"14px",pointerEvents:"none",userSelect:"none"})),lt=l.computed(()=>C.value?!1:n.placeholder&&N(r.value)),oe=l.computed(()=>v.value>0),ie=l.computed(()=>v.value<g.value.length-1),se=l.computed(()=>C.value&&d.value),D=l.computed(()=>!se.value&&!n.disabled),rt=l.computed(()=>{var e;return se.value&&((e=n.replayOptions)==null?void 0:e.showControls)!==!1}),S=l.computed(()=>{if(n.penStyle){const e=te(n.penStyle,n.strokeColor);return{strokeColor:e.strokeColor,strokeWidth:n.strokeWidth||e.strokeWidth,smoothing:n.smoothing!==void 0?n.smoothing:e.smoothing,pressure:{enabled:n.pressureSensitive!==void 0?n.pressureSensitive:e.pressure.enabled,min:n.minStrokeWidth||e.pressure.min,max:n.maxStrokeWidth||e.pressure.max},lineCap:e.lineCap,lineJoin:e.lineJoin}}return{strokeColor:n.strokeColor||"#000000",strokeWidth:n.strokeWidth||2,smoothing:n.smoothing!==void 0?n.smoothing:!0,pressure:{enabled:n.pressureSensitive||!1,min:n.minStrokeWidth||1,max:n.maxStrokeWidth||4},lineCap:"round",lineJoin:"round"}}),le=()=>{var e;return((e=c.value)==null?void 0:e.getContext("2d"))||null},O=(e,o)=>{const p=c.value,w=p.getBoundingClientRect(),m=p.width/w.width,f=p.height/w.height;return{x:(e-w.left)*m,y:(o-w.top)*f,time:Date.now()}},re=e=>{if(!D.value)return;u.value=!0;const o=performance.now(),p={...e,time:o};h.value={points:[p],strokeColor:n.strokeColor,strokeWidth:n.strokeWidth,startTime:o,endTime:o,duration:0},s("signature-start")},q=(e,o,p,w)=>{if(!S.value.pressure.enabled)return w;switch(p){case"brush":if(o){const R=Math.sqrt(Math.pow(e.x-o.x,2)+Math.pow(e.y-o.y,2))/Math.max(1,(e.time||0)-(o.time||0)),X=Math.max(.3,Math.min(2,50/Math.max(R,1))),B=e.pressure||.5;return w*X*(.5+B)}return w;case"pencil":const m=e.pressure||.5;return w*(.8+m*.4);case"ballpoint":const f=e.pressure||.5;return w*(.9+f*.2);default:return w}},z=(e,o,p)=>{var w;if(!(o.length<2))switch(e.strokeStyle=((w=h.value)==null?void 0:w.strokeColor)||S.value.strokeColor,e.lineCap=S.value.lineCap||"round",e.lineJoin=S.value.lineJoin||"round",p){case"pen":if(e.lineWidth=S.value.strokeWidth,e.beginPath(),e.moveTo(o[0].x,o[0].y),S.value.smoothing&&o.length>=3){for(let m=1;m<o.length-1;m++){const f=ce(o[m],o[m-1],o[m+1]);e.quadraticCurveTo(f.x,f.y,o[m].x,o[m].y)}e.lineTo(o[o.length-1].x,o[o.length-1].y)}else for(let m=1;m<o.length;m++)e.lineTo(o[m].x,o[m].y);e.stroke();break;case"brush":for(let m=1;m<o.length;m++){const f=o[m],T=o[m-1],R=q(f,T,p,S.value.strokeWidth);e.lineWidth=R,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(f.x,f.y),e.stroke()}break;case"marker":e.globalAlpha=.8,e.lineWidth=S.value.strokeWidth,e.beginPath(),e.moveTo(o[0].x,o[0].y);for(let m=1;m<o.length;m++)e.lineTo(o[m].x,o[m].y);e.stroke(),e.globalAlpha=1;break;case"pencil":for(let m=1;m<o.length;m++){const f=o[m],T=o[m-1],R=q(f,T,p,S.value.strokeWidth);e.lineWidth=R,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(f.x,f.y),e.stroke(),Math.random()>.7&&(e.globalAlpha=.3,e.beginPath(),e.arc(f.x+(Math.random()-.5),f.y+(Math.random()-.5),.5,0,Math.PI*2),e.fill(),e.globalAlpha=1)}break;case"ballpoint":for(let m=1;m<o.length;m++){const f=o[m],T=o[m-1],R=q(f,T,p,S.value.strokeWidth);if(e.lineWidth=R,e.beginPath(),e.moveTo(T.x,T.y),S.value.smoothing&&m<o.length-1){const X=o[m+1],B=ce(f,T,X);e.quadraticCurveTo(B.x,B.y,f.x,f.y)}else e.lineTo(f.x,f.y);e.stroke()}break}},ct=()=>{if(!h.value||h.value.points.length<2)return;const e=le();if(!e)return;const o=h.value.points,p=o.length,w=n.penStyle||"pen";if(p===2)z(e,o,w);else if(p>=3){const m=o.slice(-3);z(e,m,w)}},ce=(e,o,p)=>{const m={length:Math.sqrt(Math.pow(p.x-o.x,2)+Math.pow(p.y-o.y,2)),angle:Math.atan2(p.y-o.y,p.x-o.x)},f=m.angle+Math.PI,T=m.length*.2;return{x:e.x+Math.cos(f)*T,y:e.y+Math.sin(f)*T,time:e.time||0}},ht=(e,o)=>{if(o.points.length<2)return;const p=n.penStyle||"pen",w=h.value;h.value=o,z(e,o.points,p),h.value=w},he=e=>{if(!u.value||!h.value||!D.value)return;const o=performance.now(),p={...e,time:o};h.value.points.push(p),h.value.startTime&&(h.value.endTime=o,h.value.duration=o-h.value.startTime),ct(),ge(),s("signature-drawing",r.value)},ue=()=>{if(!(!u.value||!h.value)){if(u.value=!1,h.value.points.length>0){const e=h.value.points[h.value.points.length-1];e.time&&h.value.startTime&&(h.value.endTime=e.time,h.value.duration=e.time-h.value.startTime)}r.value.paths.push(h.value),r.value.isEmpty=!1,r.value.timestamp=Date.now(),A(),_(),h.value=null,s("signature-end",r.value)}},ut=e=>{e.preventDefault();const o=O(e.clientX,e.clientY);re(o)},dt=e=>{if(e.preventDefault(),!u.value)return;const o=O(e.clientX,e.clientY);he(o)},de=e=>{e.preventDefault(),ue()},mt=e=>{if(e.preventDefault(),e.touches.length!==1)return;const o=e.touches[0],p=O(o.clientX,o.clientY);re(p)},gt=e=>{if(e.preventDefault(),e.touches.length!==1||!u.value)return;const o=e.touches[0],p=O(o.clientX,o.clientY);he(p)},me=e=>{e.preventDefault(),ue()},ge=()=>{r.value.canvasSize={width:M.value,height:x.value},r.value.isEmpty=N(r.value)},A=()=>{g.value=g.value.slice(0,v.value+1),g.value.push(E(r.value)),v.value=g.value.length-1;const e=50;g.value.length>e&&(g.value=g.value.slice(-e),v.value=g.value.length-1)},_=()=>{const e=le();e&&(e.clearRect(0,0,M.value,x.value),n.backgroundColor&&n.backgroundColor!=="transparent"&&(e.fillStyle=n.backgroundColor,e.fillRect(0,0,M.value,x.value)),r.value.paths.forEach(o=>{o.points.length>0&&ht(e,o)}))},$=()=>{if(console.log("初始化回放控制器"),console.log("canvas引用是否存在:",!!c.value),!c.value){console.error("canvas引用不存在，无法初始化回放控制器");return}d.value&&(console.log("销毁现有回放控制器"),d.value.destroy()),console.log("创建新的回放控制器"),d.value=new K(c.value),console.log("回放控制器创建成功:",!!d.value),d.value.on("replay-start",()=>{k.value="playing",s("replay-start")}),d.value.on("replay-progress",(e,o)=>{b.value=e,I.value=o,s("replay-progress",e,o)}),d.value.on("replay-pause",()=>{k.value="paused",s("replay-pause")}),d.value.on("replay-resume",()=>{k.value="playing",s("replay-resume")}),d.value.on("replay-stop",()=>{k.value="stopped",s("replay-stop")}),d.value.on("replay-complete",()=>{k.value="completed",s("replay-complete")}),d.value.on("replay-path-start",(e,o)=>{s("replay-path-start",e,o)}),d.value.on("replay-path-end",(e,o)=>{s("replay-path-end",e,o)}),d.value.on("replay-speed-change",e=>{s("replay-speed-change",e)})},pe=(e,o)=>{if(d.value||$(),d.value){C.value=!0;const p={...o,drawOptions:S.value,penStyle:n.penStyle};d.value.setReplayData(e,p),console.log("startReplay调用，自动播放:",o==null?void 0:o.autoPlay),(o==null?void 0:o.autoPlay)===!0&&d.value.play()}},ye=e=>{C.value=e,!e&&d.value&&(d.value.stop(),_())},pt=()=>N(r.value)?null:Z(r.value),fe=()=>{console.log("play方法被调用"),console.log("回放控制器是否存在:",!!d.value),d.value||(console.log("回放控制器不存在，尝试初始化"),$()),d.value?(console.log("调用回放控制器的play方法"),d.value.play()):console.error("回放控制器初始化失败，无法播放")},ve=()=>{var e;(e=d.value)==null||e.pause()},ke=()=>{var e;(e=d.value)==null||e.stop()},we=e=>{var o;(o=d.value)==null||o.seek(e)},Te=e=>{var o;(o=d.value)==null||o.setSpeed(e)},yt=()=>{var e;return((e=d.value)==null?void 0:e.getState())||"idle"},ft=()=>{var e;return((e=d.value)==null?void 0:e.getCurrentTime())||0},Y=()=>{var e;return((e=d.value)==null?void 0:e.getTotalDuration())||0},vt=()=>{var e;return((e=d.value)==null?void 0:e.getProgress())||0},Ce=e=>{const o=Math.floor(e/1e3),p=Math.floor(o/60),w=o%60;return`${p}:${w.toString().padStart(2,"0")}`},be=()=>{D.value&&(r.value=V(M.value,x.value),_(),A(),s("signature-clear"))},Se=()=>{!oe.value||!D.value||(v.value--,r.value=E(g.value[v.value]),_(),s("signature-undo",r.value))},Pe=()=>{!ie.value||!D.value||(v.value++,r.value=E(g.value[v.value]),_(),s("signature-redo",r.value))},xe=e=>{const o=c.value;return G(o,r.value,e)},Me=()=>N(r.value),De=async e=>{if(!D.value)return;const o=c.value;await Q(o,e),r.value=V(M.value,x.value),r.value.isEmpty=!1,A()},kt=()=>E(r.value),wt=e=>{D.value&&(r.value=E(e),_(),A())},We=(e,o)=>{const p=e||M.value,w=o||x.value,m=xe({format:"png"});l.nextTick(()=>{const f=c.value;f.width=p,f.height=w,Me()||De(m),ge()})},Tt=()=>{const e=c.value;e.width=M.value,e.height=x.value,r.value=V(M.value,x.value),g.value=[E(r.value)],v.value=0,_()};return l.watch([()=>n.width,()=>n.height],()=>{l.nextTick(()=>{c.value&&We()})}),l.watch(()=>n.replayMode,e=>{e!==void 0&&ye(e)}),l.watch(()=>n.replayData,e=>{if(console.log("watch监听到回放数据变化:",e),console.log("当前回放模式:",n.replayMode),console.log("回放控制器是否存在:",!!d.value),e&&n.replayMode)if(d.value||(console.log("回放控制器未初始化，先初始化"),$()),d.value){console.log("开始设置回放数据到控制器");const o={...n.replayOptions,drawOptions:S.value,penStyle:n.penStyle};d.value.setReplayData(e,o),console.log("回放数据已更新:",e)}else console.error("回放控制器初始化失败");else e||console.log("回放数据为空，跳过设置"),n.replayMode||console.log("不在回放模式，跳过设置")},{immediate:!0}),l.onMounted(()=>{l.nextTick(()=>{Tt(),$(),n.replayMode&&n.replayData&&pe(n.replayData,n.replayOptions)})}),l.onUnmounted(()=>{d.value&&(d.value.destroy(),d.value=null)}),t({clear:be,undo:Se,redo:Pe,save:xe,isEmpty:Me,fromDataURL:De,getSignatureData:kt,setSignatureData:wt,resize:We,startReplay:pe,getReplayData:pt,setReplayMode:ye,play:fe,pause:ve,stop:ke,seek:we,setSpeed:Te,getState:yt,getCurrentTime:ft,getTotalDuration:Y,getProgress:vt}),(e,o)=>(l.openBlock(),l.createElementBlock("div",{class:"electronic-signature",style:l.normalizeStyle(ot.value)},[l.createElementVNode("canvas",{ref_key:"canvasRef",ref:c,width:M.value,height:x.value,style:l.normalizeStyle(it.value),onMousedown:ut,onMousemove:dt,onMouseup:de,onMouseleave:de,onTouchstart:mt,onTouchmove:gt,onTouchend:me,onTouchcancel:me},null,44,Ve),lt.value?(l.openBlock(),l.createElementBlock("div",{key:0,class:"signature-placeholder",style:l.normalizeStyle(st.value)},l.toDisplayString(e.placeholder),5)):l.createCommentVNode("",!0),e.showToolbar?(l.openBlock(),l.createElementBlock("div",Oe,[l.createElementVNode("button",{onClick:be,disabled:!D.value},"清除",8,Ae),l.createElementVNode("button",{onClick:Se,disabled:!D.value||!oe.value},"撤销",8,$e),l.createElementVNode("button",{onClick:Pe,disabled:!D.value||!ie.value},"重做",8,Be)])):l.createCommentVNode("",!0),rt.value?(l.openBlock(),l.createElementBlock("div",Je,[l.createElementVNode("div",Fe,[l.createElementVNode("button",{onClick:o[0]||(o[0]=p=>k.value==="playing"?ve():fe()),disabled:k.value==="idle",class:"replay-btn play-pause-btn"},[k.value==="playing"?(l.openBlock(),l.createElementBlock("span",ze,"⏸️")):(l.openBlock(),l.createElementBlock("span",Ye,"▶️"))],8,qe),l.createElementVNode("button",{onClick:o[1]||(o[1]=p=>ke()),disabled:k.value==="idle",class:"replay-btn stop-btn"}," ⏹️ ",8,Xe)]),l.createElementVNode("div",He,[l.createElementVNode("input",{type:"range",min:"0",max:Y(),value:I.value,onInput:o[2]||(o[2]=p=>we(Number(p.target.value))),class:"progress-slider",disabled:k.value==="idle"},null,40,Le),l.createElementVNode("div",Ue,[l.createElementVNode("span",null,l.toDisplayString(Ce(I.value)),1),o[4]||(o[4]=l.createElementVNode("span",null,"/",-1)),l.createElementVNode("span",null,l.toDisplayString(Ce(Y())),1)])]),l.createElementVNode("div",je,[o[6]||(o[6]=l.createElementVNode("label",null,"速度:",-1)),l.createElementVNode("select",{onChange:o[3]||(o[3]=p=>Te(Number(p.target.value))),class:"speed-select"},o[5]||(o[5]=[l.createElementVNode("option",{value:"0.5"},"0.5x",-1),l.createElementVNode("option",{value:"1",selected:""},"1x",-1),l.createElementVNode("option",{value:"1.5"},"1.5x",-1),l.createElementVNode("option",{value:"2"},"2x",-1)]),32)])])):l.createCommentVNode("",!0)],4))}}),St="",F=((i,t)=>{const a=i.__vccOpts||i;for(const[n,s]of t)a[n]=s;return a})(Ge,[["__scopeId","data-v-7dfe3ed2"]]);function ne(){return window.devicePixelRatio||1}function Qe(i){const t=i.getContext("2d"),a=ne(),n=i.clientWidth,s=i.clientHeight;return i.width=n*a,i.height=s*a,t.scale(a,a),i.style.width=n+"px",i.style.height=s+"px",t}function ae(i){if(i.paths.length===0)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let t=1/0,a=1/0,n=-1/0,s=-1/0;return i.paths.forEach(c=>{c.points.forEach(u=>{t=Math.min(t,u.x),a=Math.min(a,u.y),n=Math.max(n,u.x),s=Math.max(s,u.y)})}),{minX:t,minY:a,maxX:n,maxY:s,width:n-t,height:s-a}}function Ke(i,t,a=10){const n=ae(t);if(n.width===0||n.height===0){const r=document.createElement("canvas");return r.width=1,r.height=1,r}const s=document.createElement("canvas"),c=s.getContext("2d"),u=n.width+a*2,h=n.height+a*2;return s.width=u,s.height=h,c.drawImage(i,n.minX-a,n.minY-a,u,h,0,0,u,h),s}function Ze(i,t,a,n=!0){const s=document.createElement("canvas"),c=s.getContext("2d");let u=t,h=a;if(n){const r=i.width/i.height,g=t/a;r>g?h=t/r:u=a*r}return s.width=u,s.height=h,c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(i,0,0,u,h),s}function et(i,t,a={}){const{fontSize:n=12,fontFamily:s="Arial",color:c="#999",opacity:u=.5,position:h="bottom-right"}=a,r=document.createElement("canvas"),g=r.getContext("2d");r.width=i.width,r.height=i.height,g.drawImage(i,0,0),g.font=`${n}px ${s}`,g.fillStyle=c,g.globalAlpha=u;const d=g.measureText(t).width,C=n;let k,b;switch(h){case"top-left":k=10,b=C+10;break;case"top-right":k=i.width-d-10,b=C+10;break;case"bottom-left":k=10,b=i.height-10;break;case"bottom-right":k=i.width-d-10,b=i.height-10;break;case"center":k=(i.width-d)/2,b=(i.height+C)/2;break;default:k=i.width-d-10,b=i.height-10}return g.fillText(t,k,b),g.globalAlpha=1,r}function tt(i){const t=document.createElement("canvas"),a=t.getContext("2d");t.width=i.width,t.height=i.height,a.drawImage(i,0,0);const n=a.getImageData(0,0,i.width,i.height),s=n.data;for(let c=0;c<s.length;c+=4){const u=s[c]*.299+s[c+1]*.587+s[c+2]*.114;s[c]=u,s[c+1]=u,s[c+2]=u}return a.putImageData(n,0,0),t}const nt={install:i=>{i.component("ElectronicSignature",F)},ElectronicSignature:F},at="1.0.0";y.ElectronicSignature=F,y.PEN_STYLE_CONFIGS=J,y.SignatureReplayController=K,y.addWatermark=et,y.calculateStrokeWidth=U,y.cloneSignatureData=E,y.convertToGrayscale=tt,y.createDrawOptionsFromPenStyle=te,y.createEmptySignatureData=V,y.createReplayData=Z,y.cropSignature=Ke,y.default=nt,y.drawSmoothPath=Ee,y.exportSignature=G,y.getAllPenStyles=Ne,y.getAngle=H,y.getControlPoint=L,y.getDevicePixelRatio=ne,y.getDistance=W,y.getPenStyleConfig=ee,y.getSignatureBounds=ae,y.isSignatureEmpty=N,y.loadImageToCanvas=Q,y.resizeSignature=Ze,y.setupHighDPICanvas=Qe,y.signatureToSVG=j,y.version=at,Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

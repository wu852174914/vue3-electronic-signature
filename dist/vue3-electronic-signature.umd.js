(function(h,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],s):(h=typeof globalThis<"u"?globalThis:h||self,s(h.Vue3ElectronicSignature={},h.Vue))})(this,function(h,s){"use strict";function T(e,o){return Math.sqrt(Math.pow(o.x-e.x,2)+Math.pow(o.y-e.y,2))}function I(e,o){return Math.atan2(o.y-e.y,o.x-e.x)}function P(e,o,r,t){const n=o||e,i=r||e,c=.2,u=I(n,i)*(t?1:-1),l=T(n,i)*c;return{x:e.x+Math.cos(u)*l,y:e.y+Math.sin(u)*l,time:e.time}}function z(e,o,r){if(!r.pressure.enabled)return r.strokeWidth;const t=T(e,o),n=o.time-e.time,i=n>0?t/n:0,c=Math.max(.1,Math.min(1,1-i*.01)),{min:u,max:l}=r.pressure;return u+(l-u)*c}function M(e,o,r){if(o.length<2)return;if(e.strokeStyle=r.strokeColor,e.lineCap="round",e.lineJoin="round",!r.smoothing||o.length<3){e.beginPath(),e.lineWidth=r.strokeWidth,e.moveTo(o[0].x,o[0].y);for(let n=1;n<o.length;n++)e.lineTo(o[n].x,o[n].y);e.stroke();return}e.beginPath(),e.moveTo(o[0].x,o[0].y);for(let n=1;n<o.length-1;n++){const i=o[n],c=o[n+1];r.pressure.enabled?e.lineWidth=z(o[n-1],i,r):e.lineWidth=r.strokeWidth;const u=P(i,o[n-1],c);e.quadraticCurveTo(u.x,u.y,i.x,i.y)}const t=o[o.length-1];e.lineTo(t.x,t.y),e.stroke()}function B(e){const{canvasSize:o,paths:r}=e;let t=`<svg width="${o.width}" height="${o.height}" xmlns="http://www.w3.org/2000/svg">`;return r.forEach(n=>{if(n.points.length<2)return;let i=`M ${n.points[0].x} ${n.points[0].y}`;for(let c=1;c<n.points.length;c++)i+=` L ${n.points[c].x} ${n.points[c].y}`;t+=`<path d="${i}" stroke="${n.strokeColor}" stroke-width="${n.strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),t+="</svg>",t}function $(e,o,r={format:"png"}){const{format:t,quality:n=.9,size:i,backgroundColor:c}=r;if(t==="svg")return B(o);const u=document.createElement("canvas"),l=u.getContext("2d");if(i){u.width=i.width,u.height=i.height;const g=i.width/e.width,m=i.height/e.height;l.scale(g,m)}else u.width=e.width,u.height=e.height;switch(c&&c!=="transparent"&&(l.fillStyle=c,l.fillRect(0,0,u.width,u.height)),l.drawImage(e,0,0),t){case"jpeg":return u.toDataURL("image/jpeg",n);case"base64":return u.toDataURL("image/png").split(",")[1];case"png":default:return u.toDataURL("image/png")}}function X(e,o){return new Promise((r,t)=>{const n=new Image;n.onload=()=>{const i=e.getContext("2d");i.clearRect(0,0,e.width,e.height),i.drawImage(n,0,0,e.width,e.height),r()},n.onerror=t,n.src=o})}function x(e){return e.paths.length===0||e.paths.every(o=>o.points.length===0)}function S(e,o){return{paths:[],canvasSize:{width:e,height:o},timestamp:Date.now(),isEmpty:!0}}function k(e){return JSON.parse(JSON.stringify(e))}const oe=["width","height"],ae={key:1,class:"signature-toolbar"},ie=["disabled"],re=["disabled"],le=["disabled"],se=s.defineComponent({__name:"ElectronicSignature",props:{showToolbar:{type:Boolean,default:!1},width:{default:"100%"},height:{default:300},strokeColor:{default:"#000000"},strokeWidth:{default:2},backgroundColor:{default:"transparent"},disabled:{type:Boolean,default:!1},placeholder:{default:"请在此处签名"},smoothing:{type:Boolean,default:!0},pressureSensitive:{type:Boolean,default:!1},minStrokeWidth:{default:1},maxStrokeWidth:{default:4},borderStyle:{default:"1px solid #ddd"},borderRadius:{default:"4px"}},emits:["signature-start","signature-drawing","signature-end","signature-clear","signature-undo","signature-redo"],setup(e,{expose:o,emit:r}){const t=e,n=r,i=s.ref(),c=s.ref(!1),u=s.ref(null),l=s.ref(S(0,0)),g=s.ref([]),m=s.ref(-1),f=s.computed(()=>typeof t.width=="number"?t.width:800),p=s.computed(()=>typeof t.height=="number"?t.height:300),w=s.computed(()=>({position:"relative",display:"inline-block",width:typeof t.width=="string"?t.width:`${t.width}px`,height:typeof t.height=="string"?t.height:`${t.height}px`})),y=s.computed(()=>({border:t.borderStyle,borderRadius:t.borderRadius,backgroundColor:t.backgroundColor,cursor:t.disabled?"not-allowed":"crosshair",display:"block",width:"100%",height:"100%"})),pe=s.computed(()=>({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#999",fontSize:"14px",pointerEvents:"none",userSelect:"none"})),ve=s.computed(()=>t.placeholder&&x(l.value)),H=s.computed(()=>m.value>0),N=s.computed(()=>m.value<g.value.length-1),U=s.computed(()=>({strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,smoothing:t.smoothing,pressure:{enabled:t.pressureSensitive,min:t.minStrokeWidth,max:t.maxStrokeWidth}})),A=()=>{var a;return((a=i.value)==null?void 0:a.getContext("2d"))||null},D=(a,d)=>{const v=i.value,b=v.getBoundingClientRect(),R=v.width/b.width,_=v.height/b.height;return{x:(a-b.left)*R,y:(d-b.top)*_,time:Date.now()}},O=a=>{t.disabled||(c.value=!0,u.value={points:[a],strokeColor:t.strokeColor,strokeWidth:t.strokeWidth},n("signature-start"))},j=a=>{if(!c.value||!u.value||t.disabled)return;u.value.points.push(a);const d=A();d&&M(d,u.value.points,U.value),J(),n("signature-drawing",l.value)},L=()=>{!c.value||!u.value||(c.value=!1,l.value.paths.push(u.value),l.value.isEmpty=!1,l.value.timestamp=Date.now(),E(),u.value=null,n("signature-end",l.value))},we=a=>{a.preventDefault();const d=D(a.clientX,a.clientY);O(d)},ye=a=>{if(a.preventDefault(),!c.value)return;const d=D(a.clientX,a.clientY);j(d)},q=a=>{a.preventDefault(),L()},ke=a=>{if(a.preventDefault(),a.touches.length!==1)return;const d=a.touches[0],v=D(d.clientX,d.clientY);O(v)},be=a=>{if(a.preventDefault(),a.touches.length!==1||!c.value)return;const d=a.touches[0],v=D(d.clientX,d.clientY);j(v)},G=a=>{a.preventDefault(),L()},J=()=>{l.value.canvasSize={width:f.value,height:p.value},l.value.isEmpty=x(l.value)},E=()=>{g.value=g.value.slice(0,m.value+1),g.value.push(k(l.value)),m.value=g.value.length-1;const a=50;g.value.length>a&&(g.value=g.value.slice(-a),m.value=g.value.length-1)},C=()=>{const a=A();a&&(a.clearRect(0,0,f.value,p.value),t.backgroundColor&&t.backgroundColor!=="transparent"&&(a.fillStyle=t.backgroundColor,a.fillRect(0,0,f.value,p.value)),l.value.paths.forEach(d=>{if(d.points.length>0){const v={strokeColor:d.strokeColor,strokeWidth:d.strokeWidth,smoothing:t.smoothing,pressure:U.value.pressure};M(a,d.points,v)}}))},F=()=>{t.disabled||(l.value=S(f.value,p.value),C(),E(),n("signature-clear"))},Q=()=>{!H.value||t.disabled||(m.value--,l.value=k(g.value[m.value]),C(),n("signature-undo",l.value))},K=()=>{!N.value||t.disabled||(m.value++,l.value=k(g.value[m.value]),C(),n("signature-redo",l.value))},Z=a=>{const d=i.value;return $(d,l.value,a)},ee=()=>x(l.value),te=async a=>{if(t.disabled)return;const d=i.value;await X(d,a),l.value=S(f.value,p.value),l.value.isEmpty=!1,E()},Se=()=>k(l.value),Ce=a=>{t.disabled||(l.value=k(a),C(),E())},ne=(a,d)=>{const v=a||f.value,b=d||p.value,R=Z({format:"png"});s.nextTick(()=>{const _=i.value;_.width=v,_.height=b,ee()||te(R),J()})},xe=()=>{const a=i.value;a.width=f.value,a.height=p.value,l.value=S(f.value,p.value),g.value=[k(l.value)],m.value=0,C()};return s.watch([()=>t.width,()=>t.height],()=>{s.nextTick(()=>{i.value&&ne()})}),s.onMounted(()=>{s.nextTick(()=>{xe()})}),s.onUnmounted(()=>{}),o({clear:F,undo:Q,redo:K,save:Z,isEmpty:ee,fromDataURL:te,getSignatureData:Se,setSignatureData:Ce,resize:ne}),(a,d)=>(s.openBlock(),s.createElementBlock("div",{class:"electronic-signature",style:s.normalizeStyle(w.value)},[s.createElementVNode("canvas",{ref_key:"canvasRef",ref:i,width:f.value,height:p.value,style:s.normalizeStyle(y.value),onMousedown:we,onMousemove:ye,onMouseup:q,onMouseleave:q,onTouchstart:ke,onTouchmove:be,onTouchend:G,onTouchcancel:G},null,44,oe),ve.value?(s.openBlock(),s.createElementBlock("div",{key:0,class:"signature-placeholder",style:s.normalizeStyle(pe.value)},s.toDisplayString(a.placeholder),5)):s.createCommentVNode("",!0),a.showToolbar?(s.openBlock(),s.createElementBlock("div",ae,[s.createElementVNode("button",{onClick:F,disabled:a.disabled},"清除",8,ie),s.createElementVNode("button",{onClick:Q,disabled:a.disabled||!H.value},"撤销",8,re),s.createElementVNode("button",{onClick:K,disabled:a.disabled||!N.value},"重做",8,le)])):s.createCommentVNode("",!0)],4))}}),De="",W=((e,o)=>{const r=e.__vccOpts||e;for(const[t,n]of o)r[t]=n;return r})(se,[["__scopeId","data-v-6e7c2000"]]);function Y(){return window.devicePixelRatio||1}function ce(e){const o=e.getContext("2d"),r=Y(),t=e.clientWidth,n=e.clientHeight;return e.width=t*r,e.height=n*r,o.scale(r,r),e.style.width=t+"px",e.style.height=n+"px",o}function V(e){if(e.paths.length===0)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let o=1/0,r=1/0,t=-1/0,n=-1/0;return e.paths.forEach(i=>{i.points.forEach(c=>{o=Math.min(o,c.x),r=Math.min(r,c.y),t=Math.max(t,c.x),n=Math.max(n,c.y)})}),{minX:o,minY:r,maxX:t,maxY:n,width:t-o,height:n-r}}function ue(e,o,r=10){const t=V(o);if(t.width===0||t.height===0){const l=document.createElement("canvas");return l.width=1,l.height=1,l}const n=document.createElement("canvas"),i=n.getContext("2d"),c=t.width+r*2,u=t.height+r*2;return n.width=c,n.height=u,i.drawImage(e,t.minX-r,t.minY-r,c,u,0,0,c,u),n}function he(e,o,r,t=!0){const n=document.createElement("canvas"),i=n.getContext("2d");let c=o,u=r;if(t){const l=e.width/e.height,g=o/r;l>g?u=o/l:c=r*l}return n.width=c,n.height=u,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(e,0,0,c,u),n}function de(e,o,r={}){const{fontSize:t=12,fontFamily:n="Arial",color:i="#999",opacity:c=.5,position:u="bottom-right"}=r,l=document.createElement("canvas"),g=l.getContext("2d");l.width=e.width,l.height=e.height,g.drawImage(e,0,0),g.font=`${t}px ${n}`,g.fillStyle=i,g.globalAlpha=c;const f=g.measureText(o).width,p=t;let w,y;switch(u){case"top-left":w=10,y=p+10;break;case"top-right":w=e.width-f-10,y=p+10;break;case"bottom-left":w=10,y=e.height-10;break;case"bottom-right":w=e.width-f-10,y=e.height-10;break;case"center":w=(e.width-f)/2,y=(e.height+p)/2;break;default:w=e.width-f-10,y=e.height-10}return g.fillText(o,w,y),g.globalAlpha=1,l}function ge(e){const o=document.createElement("canvas"),r=o.getContext("2d");o.width=e.width,o.height=e.height,r.drawImage(e,0,0);const t=r.getImageData(0,0,e.width,e.height),n=t.data;for(let i=0;i<n.length;i+=4){const c=n[i]*.299+n[i+1]*.587+n[i+2]*.114;n[i]=c,n[i+1]=c,n[i+2]=c}return r.putImageData(t,0,0),o}const fe={install:e=>{e.component("ElectronicSignature",W)},ElectronicSignature:W},me="1.0.0";h.ElectronicSignature=W,h.addWatermark=de,h.calculateStrokeWidth=z,h.cloneSignatureData=k,h.convertToGrayscale=ge,h.createEmptySignatureData=S,h.cropSignature=ue,h.default=fe,h.drawSmoothPath=M,h.exportSignature=$,h.getAngle=I,h.getControlPoint=P,h.getDevicePixelRatio=Y,h.getDistance=T,h.getSignatureBounds=V,h.isSignatureEmpty=x,h.loadImageToCanvas=X,h.resizeSignature=he,h.setupHighDPICanvas=ce,h.signatureToSVG=B,h.version=me,Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

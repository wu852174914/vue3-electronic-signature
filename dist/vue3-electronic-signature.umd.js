(function(y,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],r):(y=typeof globalThis<"u"?globalThis:y||self,r(y.Vue3ElectronicSignature={},y.Vue))})(this,function(y,r){"use strict";var Pt=Object.defineProperty;var Mt=(y,r,E)=>r in y?Pt(y,r,{enumerable:!0,configurable:!0,writable:!0,value:E}):y[r]=E;var P=(y,r,E)=>(Mt(y,typeof r!="symbol"?r+"":r,E),E);function E(l,t){return Math.sqrt(Math.pow(t.x-l.x,2)+Math.pow(t.y-l.y,2))}function H(l,t){return Math.atan2(t.y-l.y,t.x-l.x)}function U(l,t,o,n){const i=t||l,h=o||l,c=.2,u=H(i,h)*(n?1:-1),s=E(i,h)*c;return{x:l.x+Math.cos(u)*s,y:l.y+Math.sin(u)*s,time:l.time}}function j(l,t,o){if(!o.pressure.enabled)return o.strokeWidth;const n=E(l,t),i=t.time-l.time,h=i>0?n/i:0,c=Math.max(.1,Math.min(1,1-h*.01)),{min:u,max:s}=o.pressure;return u+(s-u)*c}function _e(l,t,o){if(t.length<2)return;if(l.strokeStyle=o.strokeColor,l.lineCap="round",l.lineJoin="round",!o.smoothing||t.length<3){l.beginPath(),l.lineWidth=o.strokeWidth,l.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)l.lineTo(t[i].x,t[i].y);l.stroke();return}l.beginPath(),l.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length-1;i++){const h=t[i],c=t[i+1];o.pressure.enabled?l.lineWidth=j(t[i-1],h,o):l.lineWidth=o.strokeWidth;const u=U(h,t[i-1],c);l.quadraticCurveTo(u.x,u.y,h.x,h.y)}const n=t[t.length-1];l.lineTo(n.x,n.y),l.stroke()}function G(l){const{canvasSize:t,paths:o}=l;let n=`<svg width="${t.width}" height="${t.height}" xmlns="http://www.w3.org/2000/svg">`;return o.forEach(i=>{if(i.points.length<2)return;let h=`M ${i.points[0].x} ${i.points[0].y}`;for(let c=1;c<i.points.length;c++)h+=` L ${i.points[c].x} ${i.points[c].y}`;n+=`<path d="${h}" stroke="${i.strokeColor}" stroke-width="${i.strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),n+="</svg>",n}function Q(l,t,o={format:"png"}){const{format:n,quality:i=.9,size:h,backgroundColor:c}=o;if(n==="svg")return G(t);const u=document.createElement("canvas"),s=u.getContext("2d");if(h){u.width=h.width,u.height=h.height;const g=h.width/l.width,v=h.height/l.height;s.scale(g,v)}else u.width=l.width,u.height=l.height;switch(c&&c!=="transparent"&&(s.fillStyle=c,s.fillRect(0,0,u.width,u.height)),s.drawImage(l,0,0),n){case"jpeg":return u.toDataURL("image/jpeg",i);case"base64":return u.toDataURL("image/png").split(",")[1];case"png":default:return u.toDataURL("image/png")}}function K(l,t){return new Promise((o,n)=>{const i=new Image;i.onload=()=>{const h=l.getContext("2d");h.clearRect(0,0,l.width,l.height),h.drawImage(i,0,0,l.width,l.height),o()},i.onerror=n,i.src=t})}function V(l){return l.paths.length===0||l.paths.every(t=>t.points.length===0)}function O(l,t){return{paths:[],canvasSize:{width:l,height:t},timestamp:Date.now(),isEmpty:!0}}function R(l){return JSON.parse(JSON.stringify(l))}class Z{constructor(t){P(this,"canvas");P(this,"ctx");P(this,"replayData",null);P(this,"state","idle");P(this,"currentTime",0);P(this,"speed",1);P(this,"animationId",null);P(this,"startTimestamp",0);P(this,"pausedTime",0);P(this,"options",{});P(this,"eventCallbacks",new Map);this.canvas=t,this.ctx=t.getContext("2d")}setReplayData(t,o={}){console.log("设置回放数据:",t),console.log("回放选项:",o),this.replayData=t,this.options={...o},this.speed=o.speed||t.speed||1,this.currentTime=o.startTime||0,this.state="idle",console.log("回放数据设置完成，路径数量:",t.paths.length),console.log("总时长:",t.totalDuration)}play(){if(console.log("播放方法调用，回放数据:",this.replayData),console.log("当前状态:",this.state),!this.replayData){console.error("没有回放数据，无法播放");return}if(this.replayData.totalDuration<=0){console.error("回放数据总时长为0，无法播放");return}if(this.replayData.paths.length===0){console.error("回放数据没有路径，无法播放");return}if(this.state==="playing"){console.log("已在播放中，忽略");return}this.state==="paused"?(console.log("从暂停状态恢复播放"),this.state="playing",this.startTimestamp=performance.now()-this.pausedTime,this.emit("replay-resume")):(console.log("开始新的播放"),this.state="playing",this.startTimestamp=performance.now(),this.pausedTime=0,this.currentTime=this.options.startTime||0,this.clearCanvas(),this.emit("replay-start")),this.animate()}pause(){this.state==="playing"&&(this.state="paused",this.pausedTime=performance.now()-this.startTimestamp,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.emit("replay-pause"))}stop(){this.state="stopped",this.currentTime=0,this.pausedTime=0,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clearCanvas(),this.emit("replay-stop")}seek(t){if(!this.replayData)return;const o=this.options.endTime||this.replayData.totalDuration;this.currentTime=Math.max(0,Math.min(t,o)),this.state==="playing"?this.startTimestamp=performance.now()-this.currentTime/this.speed:this.pausedTime=this.currentTime/this.speed,this.renderFrame(this.currentTime)}setSpeed(t){const o=this.state==="playing";o&&this.pause(),this.speed=Math.max(.1,Math.min(5,t)),this.emit("replay-speed-change",this.speed),o&&this.play()}getState(){return this.state}getCurrentTime(){return this.currentTime}getTotalDuration(){var t;return((t=this.replayData)==null?void 0:t.totalDuration)||0}getProgress(){const t=this.getTotalDuration();return t>0?this.currentTime/t:0}animate(){if(this.state!=="playing"||!this.replayData)return;const t=performance.now();this.currentTime=(t-this.startTimestamp)*this.speed;const o=this.options.endTime||this.replayData.totalDuration;if(this.currentTime>=o){this.currentTime=o,this.state="completed",this.renderFrame(this.currentTime),this.emit("replay-complete"),this.options.loop&&setTimeout(()=>{this.currentTime=this.options.startTime||0,this.play()},500);return}this.renderFrame(this.currentTime),this.emit("replay-progress",this.getProgress(),this.currentTime),this.animationId=requestAnimationFrame(()=>this.animate())}renderFrame(t){if(!this.replayData)return;this.clearCanvas();let o=!1;for(let n=0;n<this.replayData.paths.length;n++){const i=this.replayData.paths[n],h=i.startTime||0,c=i.endTime||h+(i.duration||0);if(t<h)break;if(t>=c){this.drawCompletePath(i),!o&&Math.abs(t-c)<32&&this.emit("replay-path-end",n,i);continue}o=!0;const u=Math.max(0,Math.min(1,(t-h)/Math.max(c-h,1)));u>0&&Math.abs(t-h)<32&&this.emit("replay-path-start",n,i),this.drawPartialPath(i,u);break}}drawCompletePath(t){if(t.points.length<2)return;const o=this.options.drawOptions||{strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,smoothing:!0,pressure:{enabled:!1,min:1,max:4}};this.drawPathWithSmoothAlgorithm(t.points,{...o,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth})}drawPartialPath(t,o){if(t.points.length<2)return;const n=t.startTime||0,i=t.duration||0,h=n+i*o,c=this.getPointsUpToTime(t.points,n,h);if(c.length<2)return;const u=this.options.drawOptions||{strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,smoothing:!0,pressure:{enabled:!1,min:1,max:4}};this.drawPathWithSmoothAlgorithm(c,{...u,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth})}getPointsUpToTime(t,o,n){const i=[];for(let h=0;h<t.length;h++){const c=t[h],u=o+(c.relativeTime||h*50);if(u<=n)i.push(c);else{if(h>0){const s=t[h-1],g=o+(s.relativeTime||(h-1)*50);if(g<=n){const v=(n-g)/(u-g),d={x:s.x+(c.x-s.x)*v,y:s.y+(c.y-s.y)*v,time:n,pressure:s.pressure?s.pressure+(c.pressure||s.pressure-s.pressure)*v:c.pressure};i.push(d)}}break}}return i}drawPathWithSmoothAlgorithm(t,o){if(t.length<2)return;if(this.ctx.strokeStyle=o.strokeColor,this.ctx.lineCap="round",this.ctx.lineJoin="round",!o.smoothing||t.length<3){this.ctx.beginPath(),this.ctx.lineWidth=o.strokeWidth,this.ctx.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i].x,t[i].y);this.ctx.stroke();return}this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length-1;i++){const h=t[i],c=t[i+1];this.ctx.lineWidth=o.strokeWidth;const u=this.getControlPoint(h,t[i-1],c);this.ctx.quadraticCurveTo(u.x,u.y,h.x,h.y)}const n=t[t.length-1];this.ctx.lineTo(n.x,n.y),this.ctx.stroke()}getControlPoint(t,o,n){const h={length:Math.sqrt(Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2)),angle:Math.atan2(n.y-o.y,n.x-o.x)},c=h.angle+Math.PI,u=h.length*.2;return{x:t.x+Math.cos(c)*u,y:t.y+Math.sin(c)*u,time:t.time||0}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}on(t,o){this.eventCallbacks.has(t)||this.eventCallbacks.set(t,[]),this.eventCallbacks.get(t).push(o)}off(t,o){if(this.eventCallbacks.has(t))if(o){const n=this.eventCallbacks.get(t),i=n.indexOf(o);i>-1&&n.splice(i,1)}else this.eventCallbacks.delete(t)}emit(t,...o){const n=this.eventCallbacks.get(t);n&&n.forEach(i=>i(...o))}destroy(){this.stop(),this.eventCallbacks.clear(),this.replayData=null}}function ee(l){const t=l.paths.map(s=>{const g=s.points.map((d,C)=>{var b;let k;if(d.time&&s.points[0].time)k=d.time-s.points[0].time;else if(C===0)k=0;else{const A=s.points[C-1],M=Math.sqrt(Math.pow(d.x-A.x,2)+Math.pow(d.y-A.y,2))/100*1e3;k=(((b=g[C-1])==null?void 0:b.relativeTime)||0)+Math.max(M,16)}return{...d,relativeTime:k}}),v=g.length>0?g[g.length-1].relativeTime:0;return{...s,points:g,duration:v}}),o=[];for(let s=0;s<t.length;s++){const g=t[s];let v;if(s===0)v=0;else{const k=o[s-1],b=Re(l.paths[s-1].points,l.paths[s].points);v=k.endTime+b}const d=v+g.duration,C={...g,startTime:v,endTime:d};console.log(`路径 ${s}: 开始时间=${v}, 结束时间=${d}, 持续时间=${g.duration}`),o.push(C)}const n=o.length>0?o[o.length-1].endTime:0;console.log("回放数据生成完成:"),console.log("- 路径数量:",o.length),console.log("- 总时长:",n),console.log("- 路径详情:",o.map(s=>({startTime:s.startTime,endTime:s.endTime,duration:s.duration,pointCount:s.points.length})));const i=o.reduce((s,g)=>s+Ne(g.points),0),h=n>0?i/(n/1e3):0,c=o.slice(1).map((s,g)=>{const v=o[g];return s.startTime-v.endTime}),u=c.length>0?c.reduce((s,g)=>s+g,0)/c.length:0;return{paths:o,totalDuration:n,speed:1,metadata:{deviceType:Ie(l),averageSpeed:h,totalDistance:i,averagePauseTime:u}}}function Re(l,t){if(l.length===0||t.length===0)return 200;const o=l[l.length-1],n=t[0];if(o.time&&n.time)return Math.max(n.time-o.time,50);const i=Math.sqrt(Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2));return Math.min(Math.max(i*2,100),1e3)}function Ie(l){const t=l.paths.reduce((h,c)=>h+c.points.length,0),o=l.paths.length;if(t===0)return"touch";const n=t/o;return n>20?"touch":n<10?"mouse":l.paths.some(h=>h.points.some(c=>c.pressure!==void 0))?"pen":"touch"}function Ne(l){let t=0;for(let o=1;o<l.length;o++){const n=l[o].x-l[o-1].x,i=l[o].y-l[o-1].y;t+=Math.sqrt(n*n+i*i)}return t}const F={pen:{name:"钢笔",description:"极细线条，锐利精准，商务签名",strokeWidth:1,smoothing:!0,pressure:{enabled:!1,min:1,max:1},lineCap:"butt",lineJoin:"miter",recommendedColor:"#000080"},brush:{name:"毛笔",description:"粗细变化极大，传统书法效果",strokeWidth:8,smoothing:!0,pressure:{enabled:!0,min:1,max:16},lineCap:"round",lineJoin:"round",recommendedColor:"#2c3e50"},marker:{name:"马克笔",description:"超粗线条，荧光笔效果",strokeWidth:12,smoothing:!1,pressure:{enabled:!1,min:10,max:14},lineCap:"square",lineJoin:"bevel",recommendedColor:"#ff6b35"},pencil:{name:"铅笔",description:"粗糙纹理，素描效果",strokeWidth:3,smoothing:!1,pressure:{enabled:!0,min:2,max:5},lineCap:"round",lineJoin:"round",recommendedColor:"#666666"},ballpoint:{name:"圆珠笔",description:"细线条，轻微断续效果",strokeWidth:1.2,smoothing:!0,pressure:{enabled:!0,min:.8,max:1.8},lineCap:"round",lineJoin:"round",recommendedColor:"#1e3a8a"}};function te(l){return F[l]}function Ae(){return Object.entries(F).map(([l,t])=>({key:l,config:t}))}function ne(l,t){const o=te(l);return{strokeWidth:o.strokeWidth,smoothing:o.smoothing,pressure:o.pressure,lineCap:o.lineCap,lineJoin:o.lineJoin,strokeColor:t||o.recommendedColor||"#000000"}}const Ve=["width","height"],Oe={key:1,class:"signature-toolbar"},Je=["disabled"],$e=["disabled"],Be=["disabled"],qe={key:2,class:"replay-controls"},Fe={class:"replay-buttons"},ze=["disabled"],Ye={key:0},Xe={key:1},Le=["disabled"],He={class:"replay-progress"},Ue=["max","value","disabled"],je={class:"time-display"},Ge={class:"replay-speed"},Qe=r.defineComponent({__name:"ElectronicSignature",props:{showToolbar:{type:Boolean,default:!1},width:{default:"100%"},height:{default:300},penStyle:{default:"pen"},strokeColor:{default:"#000000"},strokeWidth:{default:2},backgroundColor:{default:"transparent"},disabled:{type:Boolean,default:!1},placeholder:{default:"请在此处签名"},smoothing:{type:Boolean,default:!0},pressureSensitive:{type:Boolean,default:!1},minStrokeWidth:{default:1},maxStrokeWidth:{default:4},borderStyle:{default:"1px solid #ddd"},borderRadius:{default:"4px"},replayMode:{type:Boolean},replayData:{},replayOptions:{}},emits:["signature-start","signature-drawing","signature-end","signature-clear","signature-undo","signature-redo","replay-start","replay-progress","replay-pause","replay-resume","replay-stop","replay-complete","replay-path-start","replay-path-end","replay-speed-change"],setup(l,{expose:t,emit:o}){const n=l,i=o,h=r.ref(),c=r.ref(!1),u=r.ref(null),s=r.ref(O(0,0)),g=r.ref([]),v=r.ref(-1),d=r.ref(null),C=r.ref(!1),k=r.ref("idle"),b=r.ref(0),A=r.ref(0),W=r.computed(()=>typeof n.width=="number"?n.width:800),M=r.computed(()=>typeof n.height=="number"?n.height:300),lt=r.computed(()=>({position:"relative",display:"inline-block",width:typeof n.width=="string"?n.width:`${n.width}px`,height:typeof n.height=="string"?n.height:`${n.height}px`})),it=r.computed(()=>({border:n.borderStyle,borderRadius:n.borderRadius,backgroundColor:n.backgroundColor,cursor:n.disabled?"not-allowed":"crosshair",display:"block",width:"100%",height:"100%"})),rt=r.computed(()=>({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#999",fontSize:"14px",pointerEvents:"none",userSelect:"none"})),st=r.computed(()=>C.value?!1:n.placeholder&&V(s.value)),le=r.computed(()=>v.value>0),ie=r.computed(()=>v.value<g.value.length-1),re=r.computed(()=>C.value&&d.value),x=r.computed(()=>!re.value&&!n.disabled),ht=r.computed(()=>{var e;return re.value&&((e=n.replayOptions)==null?void 0:e.showControls)!==!1}),_=r.computed(()=>{if(n.penStyle){const e=ne(n.penStyle,n.strokeColor);return{strokeColor:e.strokeColor,strokeWidth:n.strokeWidth||e.strokeWidth,smoothing:n.smoothing!==void 0?n.smoothing:e.smoothing,pressure:{enabled:n.pressureSensitive!==void 0?n.pressureSensitive:e.pressure.enabled,min:n.minStrokeWidth||e.pressure.min,max:n.maxStrokeWidth||e.pressure.max},lineCap:e.lineCap,lineJoin:e.lineJoin}}return{strokeColor:n.strokeColor||"#000000",strokeWidth:n.strokeWidth||2,smoothing:n.smoothing!==void 0?n.smoothing:!0,pressure:{enabled:n.pressureSensitive||!1,min:n.minStrokeWidth||1,max:n.maxStrokeWidth||4},lineCap:"round",lineJoin:"round"}}),se=()=>{var e;return((e=h.value)==null?void 0:e.getContext("2d"))||null},J=(e,a)=>{const p=h.value,T=p.getBoundingClientRect(),m=p.width/T.width,f=p.height/T.height;return{x:(e-T.left)*m,y:(a-T.top)*f,time:Date.now()}},he=e=>{if(!x.value)return;c.value=!0;const a=performance.now(),p={...e,time:a};u.value={points:[p],strokeColor:n.strokeColor,strokeWidth:n.strokeWidth,startTime:a,endTime:a,duration:0},i("signature-start")},Y=(e,a,p,T)=>{switch(p){case"pen":return 1;case"brush":if(a){const D=Math.sqrt(Math.pow(e.x-a.x,2)+Math.pow(e.y-a.y,2)),S=Math.max(1,(e.time||0)-(a.time||0)),N=D/S,q=Math.max(.1,Math.min(3,100/Math.max(N,1))),bt=e.pressure||.5,St=.8+Math.random()*.4;return Math.max(1,Math.min(20,T*q*(.3+bt*1.4)*St))}return T;case"marker":return 12;case"pencil":const m=e.pressure||.5,f=.9+Math.random()*.2;return T*(.7+m*.6)*f;case"ballpoint":const w=e.pressure||.5;return T*(.8+w*.4);default:return T}},X=(e,a,p)=>{var T;if(!(a.length<2))switch(e.strokeStyle=((T=u.value)==null?void 0:T.strokeColor)||_.value.strokeColor,e.lineCap=_.value.lineCap||"round",e.lineJoin=_.value.lineJoin||"round",p){case"pen":if(e.lineWidth=1,e.lineCap="butt",e.lineJoin="miter",e.beginPath(),e.moveTo(a[0].x,a[0].y),a.length>=3){for(let m=1;m<a.length-1;m++){const f=ue(a[m],a[m-1],a[m+1]);e.quadraticCurveTo(f.x,f.y,a[m].x,a[m].y)}e.lineTo(a[a.length-1].x,a[a.length-1].y)}else for(let m=1;m<a.length;m++)e.lineTo(a[m].x,a[m].y);e.stroke();break;case"brush":e.lineCap="round",e.lineJoin="round";for(let m=1;m<a.length;m++){const f=a[m],w=a[m-1],D=Y(f,w,p,_.value.strokeWidth),S=e.createLinearGradient(w.x,w.y,f.x,f.y);S.addColorStop(0,e.strokeStyle),S.addColorStop(1,e.strokeStyle),e.lineWidth=D,e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(f.x,f.y),e.stroke(),D>8&&Math.random()>.6&&(e.globalAlpha=.2,e.beginPath(),e.arc(f.x,f.y,D*.3,0,Math.PI*2),e.fill(),e.globalAlpha=1)}break;case"marker":e.globalAlpha=.7,e.lineWidth=12,e.lineCap="square",e.lineJoin="bevel",e.beginPath(),e.moveTo(a[0].x,a[0].y);for(let m=1;m<a.length;m++)e.lineTo(a[m].x,a[m].y);e.stroke(),e.globalAlpha=.3,e.lineWidth=16,e.beginPath(),e.moveTo(a[0].x,a[0].y);for(let m=1;m<a.length;m++)e.lineTo(a[m].x,a[m].y);e.stroke(),e.globalAlpha=1;break;case"pencil":e.lineCap="round",e.lineJoin="round";for(let m=1;m<a.length;m++){const f=a[m],w=a[m-1],D=Y(f,w,p,_.value.strokeWidth);e.lineWidth=D,e.globalAlpha=.8,e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(f.x,f.y),e.stroke();for(let S=0;S<3;S++)if(Math.random()>.5){e.globalAlpha=.2,e.lineWidth=D*.3;const N=(Math.random()-.5)*2,q=(Math.random()-.5)*2;e.beginPath(),e.moveTo(w.x+N,w.y+q),e.lineTo(f.x+N,f.y+q),e.stroke()}if(Math.random()>.8){e.globalAlpha=.4;for(let S=0;S<5;S++)e.beginPath(),e.arc(f.x+(Math.random()-.5)*3,f.y+(Math.random()-.5)*3,Math.random()*.8,0,Math.PI*2),e.fill()}}e.globalAlpha=1;break;case"ballpoint":e.lineCap="round",e.lineJoin="round";for(let m=1;m<a.length;m++){const f=a[m],w=a[m-1],D=Y(f,w,p,_.value.strokeWidth);if(Math.random()>.1){if(e.lineWidth=D,e.globalAlpha=Math.random()>.2?1:.7,e.beginPath(),_.value.smoothing&&m<a.length-1){const S=a[m+1],N=ue(f,w,S);e.moveTo(w.x,w.y),e.quadraticCurveTo(N.x,N.y,f.x,f.y)}else e.moveTo(w.x,w.y),e.lineTo(f.x,f.y);e.stroke()}Math.random()>.95&&(e.globalAlpha=.8,e.beginPath(),e.arc(f.x,f.y,D*.8,0,Math.PI*2),e.fill())}e.globalAlpha=1;break}},ut=()=>{if(!u.value||u.value.points.length<2)return;const e=se();if(!e)return;const a=u.value.points,p=a.length,T=n.penStyle||"pen";if(p===2)X(e,a,T);else if(p>=3){const m=a.slice(-3);X(e,m,T)}},ue=(e,a,p)=>{const m={length:Math.sqrt(Math.pow(p.x-a.x,2)+Math.pow(p.y-a.y,2)),angle:Math.atan2(p.y-a.y,p.x-a.x)},f=m.angle+Math.PI,w=m.length*.2;return{x:e.x+Math.cos(f)*w,y:e.y+Math.sin(f)*w,time:e.time||0}},ct=(e,a)=>{if(a.points.length<2)return;const p=n.penStyle||"pen",T=u.value;u.value=a,X(e,a.points,p),u.value=T},ce=e=>{if(!c.value||!u.value||!x.value)return;const a=performance.now(),p={...e,time:a};u.value.points.push(p),u.value.startTime&&(u.value.endTime=a,u.value.duration=a-u.value.startTime),ut(),pe(),i("signature-drawing",s.value)},de=()=>{if(!(!c.value||!u.value)){if(c.value=!1,u.value.points.length>0){const e=u.value.points[u.value.points.length-1];e.time&&u.value.startTime&&(u.value.endTime=e.time,u.value.duration=e.time-u.value.startTime)}s.value.paths.push(u.value),s.value.isEmpty=!1,s.value.timestamp=Date.now(),$(),I(),u.value=null,i("signature-end",s.value)}},dt=e=>{e.preventDefault();const a=J(e.clientX,e.clientY);he(a)},mt=e=>{if(e.preventDefault(),!c.value)return;const a=J(e.clientX,e.clientY);ce(a)},me=e=>{e.preventDefault(),de()},gt=e=>{if(e.preventDefault(),e.touches.length!==1)return;const a=e.touches[0],p=J(a.clientX,a.clientY);he(p)},pt=e=>{if(e.preventDefault(),e.touches.length!==1||!c.value)return;const a=e.touches[0],p=J(a.clientX,a.clientY);ce(p)},ge=e=>{e.preventDefault(),de()},pe=()=>{s.value.canvasSize={width:W.value,height:M.value},s.value.isEmpty=V(s.value)},$=()=>{g.value=g.value.slice(0,v.value+1),g.value.push(R(s.value)),v.value=g.value.length-1;const e=50;g.value.length>e&&(g.value=g.value.slice(-e),v.value=g.value.length-1)},I=()=>{const e=se();e&&(e.clearRect(0,0,W.value,M.value),n.backgroundColor&&n.backgroundColor!=="transparent"&&(e.fillStyle=n.backgroundColor,e.fillRect(0,0,W.value,M.value)),s.value.paths.forEach(a=>{a.points.length>0&&ct(e,a)}))},B=()=>{if(console.log("初始化回放控制器"),console.log("canvas引用是否存在:",!!h.value),!h.value){console.error("canvas引用不存在，无法初始化回放控制器");return}d.value&&(console.log("销毁现有回放控制器"),d.value.destroy()),console.log("创建新的回放控制器"),d.value=new Z(h.value),console.log("回放控制器创建成功:",!!d.value),d.value.on("replay-start",()=>{k.value="playing",i("replay-start")}),d.value.on("replay-progress",(e,a)=>{b.value=e,A.value=a,i("replay-progress",e,a)}),d.value.on("replay-pause",()=>{k.value="paused",i("replay-pause")}),d.value.on("replay-resume",()=>{k.value="playing",i("replay-resume")}),d.value.on("replay-stop",()=>{k.value="stopped",i("replay-stop")}),d.value.on("replay-complete",()=>{k.value="completed",i("replay-complete")}),d.value.on("replay-path-start",(e,a)=>{i("replay-path-start",e,a)}),d.value.on("replay-path-end",(e,a)=>{i("replay-path-end",e,a)}),d.value.on("replay-speed-change",e=>{i("replay-speed-change",e)})},ye=(e,a)=>{if(d.value||B(),d.value){C.value=!0;const p={...a,drawOptions:_.value,penStyle:n.penStyle};d.value.setReplayData(e,p),console.log("startReplay调用，自动播放:",a==null?void 0:a.autoPlay),(a==null?void 0:a.autoPlay)===!0&&d.value.play()}},fe=e=>{C.value=e,!e&&d.value&&(d.value.stop(),I())},yt=()=>V(s.value)?null:ee(s.value),ve=()=>{console.log("play方法被调用"),console.log("回放控制器是否存在:",!!d.value),d.value||(console.log("回放控制器不存在，尝试初始化"),B()),d.value?(console.log("调用回放控制器的play方法"),d.value.play()):console.error("回放控制器初始化失败，无法播放")},ke=()=>{var e;(e=d.value)==null||e.pause()},Te=()=>{var e;(e=d.value)==null||e.stop()},we=e=>{var a;(a=d.value)==null||a.seek(e)},Ce=e=>{var a;(a=d.value)==null||a.setSpeed(e)},ft=()=>{var e;return((e=d.value)==null?void 0:e.getState())||"idle"},vt=()=>{var e;return((e=d.value)==null?void 0:e.getCurrentTime())||0},L=()=>{var e;return((e=d.value)==null?void 0:e.getTotalDuration())||0},kt=()=>{var e;return((e=d.value)==null?void 0:e.getProgress())||0},be=e=>{const a=Math.floor(e/1e3),p=Math.floor(a/60),T=a%60;return`${p}:${T.toString().padStart(2,"0")}`},Se=()=>{x.value&&(s.value=O(W.value,M.value),I(),$(),i("signature-clear"))},Pe=()=>{!le.value||!x.value||(v.value--,s.value=R(g.value[v.value]),I(),i("signature-undo",s.value))},Me=()=>{!ie.value||!x.value||(v.value++,s.value=R(g.value[v.value]),I(),i("signature-redo",s.value))},De=e=>{const a=h.value;return Q(a,s.value,e)},We=()=>V(s.value),xe=async e=>{if(!x.value)return;const a=h.value;await K(a,e),s.value=O(W.value,M.value),s.value.isEmpty=!1,$()},Tt=()=>R(s.value),wt=e=>{x.value&&(s.value=R(e),I(),$())},Ee=(e,a)=>{const p=e||W.value,T=a||M.value,m=De({format:"png"});r.nextTick(()=>{const f=h.value;f.width=p,f.height=T,We()||xe(m),pe()})},Ct=()=>{const e=h.value;e.width=W.value,e.height=M.value,s.value=O(W.value,M.value),g.value=[R(s.value)],v.value=0,I()};return r.watch([()=>n.width,()=>n.height],()=>{r.nextTick(()=>{h.value&&Ee()})}),r.watch(()=>n.replayMode,e=>{e!==void 0&&fe(e)}),r.watch(()=>n.replayData,e=>{if(console.log("watch监听到回放数据变化:",e),console.log("当前回放模式:",n.replayMode),console.log("回放控制器是否存在:",!!d.value),e&&n.replayMode)if(d.value||(console.log("回放控制器未初始化，先初始化"),B()),d.value){console.log("开始设置回放数据到控制器");const a={...n.replayOptions,drawOptions:_.value,penStyle:n.penStyle};d.value.setReplayData(e,a),console.log("回放数据已更新:",e)}else console.error("回放控制器初始化失败");else e||console.log("回放数据为空，跳过设置"),n.replayMode||console.log("不在回放模式，跳过设置")},{immediate:!0}),r.onMounted(()=>{r.nextTick(()=>{Ct(),B(),n.replayMode&&n.replayData&&ye(n.replayData,n.replayOptions)})}),r.onUnmounted(()=>{d.value&&(d.value.destroy(),d.value=null)}),t({clear:Se,undo:Pe,redo:Me,save:De,isEmpty:We,fromDataURL:xe,getSignatureData:Tt,setSignatureData:wt,resize:Ee,startReplay:ye,getReplayData:yt,setReplayMode:fe,play:ve,pause:ke,stop:Te,seek:we,setSpeed:Ce,getState:ft,getCurrentTime:vt,getTotalDuration:L,getProgress:kt}),(e,a)=>(r.openBlock(),r.createElementBlock("div",{class:"electronic-signature",style:r.normalizeStyle(lt.value)},[r.createElementVNode("canvas",{ref_key:"canvasRef",ref:h,width:W.value,height:M.value,style:r.normalizeStyle(it.value),onMousedown:dt,onMousemove:mt,onMouseup:me,onMouseleave:me,onTouchstart:gt,onTouchmove:pt,onTouchend:ge,onTouchcancel:ge},null,44,Ve),st.value?(r.openBlock(),r.createElementBlock("div",{key:0,class:"signature-placeholder",style:r.normalizeStyle(rt.value)},r.toDisplayString(e.placeholder),5)):r.createCommentVNode("",!0),e.showToolbar?(r.openBlock(),r.createElementBlock("div",Oe,[r.createElementVNode("button",{onClick:Se,disabled:!x.value},"清除",8,Je),r.createElementVNode("button",{onClick:Pe,disabled:!x.value||!le.value},"撤销",8,$e),r.createElementVNode("button",{onClick:Me,disabled:!x.value||!ie.value},"重做",8,Be)])):r.createCommentVNode("",!0),ht.value?(r.openBlock(),r.createElementBlock("div",qe,[r.createElementVNode("div",Fe,[r.createElementVNode("button",{onClick:a[0]||(a[0]=p=>k.value==="playing"?ke():ve()),disabled:k.value==="idle",class:"replay-btn play-pause-btn"},[k.value==="playing"?(r.openBlock(),r.createElementBlock("span",Ye,"⏸️")):(r.openBlock(),r.createElementBlock("span",Xe,"▶️"))],8,ze),r.createElementVNode("button",{onClick:a[1]||(a[1]=p=>Te()),disabled:k.value==="idle",class:"replay-btn stop-btn"}," ⏹️ ",8,Le)]),r.createElementVNode("div",He,[r.createElementVNode("input",{type:"range",min:"0",max:L(),value:A.value,onInput:a[2]||(a[2]=p=>we(Number(p.target.value))),class:"progress-slider",disabled:k.value==="idle"},null,40,Ue),r.createElementVNode("div",je,[r.createElementVNode("span",null,r.toDisplayString(be(A.value)),1),a[4]||(a[4]=r.createElementVNode("span",null,"/",-1)),r.createElementVNode("span",null,r.toDisplayString(be(L())),1)])]),r.createElementVNode("div",Ge,[a[6]||(a[6]=r.createElementVNode("label",null,"速度:",-1)),r.createElementVNode("select",{onChange:a[3]||(a[3]=p=>Ce(Number(p.target.value))),class:"speed-select"},a[5]||(a[5]=[r.createElementVNode("option",{value:"0.5"},"0.5x",-1),r.createElementVNode("option",{value:"1",selected:""},"1x",-1),r.createElementVNode("option",{value:"1.5"},"1.5x",-1),r.createElementVNode("option",{value:"2"},"2x",-1)]),32)])])):r.createCommentVNode("",!0)],4))}}),Dt="",z=((l,t)=>{const o=l.__vccOpts||l;for(const[n,i]of t)o[n]=i;return o})(Qe,[["__scopeId","data-v-4831cb0a"]]);function ae(){return window.devicePixelRatio||1}function Ke(l){const t=l.getContext("2d"),o=ae(),n=l.clientWidth,i=l.clientHeight;return l.width=n*o,l.height=i*o,t.scale(o,o),l.style.width=n+"px",l.style.height=i+"px",t}function oe(l){if(l.paths.length===0)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let t=1/0,o=1/0,n=-1/0,i=-1/0;return l.paths.forEach(h=>{h.points.forEach(c=>{t=Math.min(t,c.x),o=Math.min(o,c.y),n=Math.max(n,c.x),i=Math.max(i,c.y)})}),{minX:t,minY:o,maxX:n,maxY:i,width:n-t,height:i-o}}function Ze(l,t,o=10){const n=oe(t);if(n.width===0||n.height===0){const s=document.createElement("canvas");return s.width=1,s.height=1,s}const i=document.createElement("canvas"),h=i.getContext("2d"),c=n.width+o*2,u=n.height+o*2;return i.width=c,i.height=u,h.drawImage(l,n.minX-o,n.minY-o,c,u,0,0,c,u),i}function et(l,t,o,n=!0){const i=document.createElement("canvas"),h=i.getContext("2d");let c=t,u=o;if(n){const s=l.width/l.height,g=t/o;s>g?u=t/s:c=o*s}return i.width=c,i.height=u,h.imageSmoothingEnabled=!0,h.imageSmoothingQuality="high",h.drawImage(l,0,0,c,u),i}function tt(l,t,o={}){const{fontSize:n=12,fontFamily:i="Arial",color:h="#999",opacity:c=.5,position:u="bottom-right"}=o,s=document.createElement("canvas"),g=s.getContext("2d");s.width=l.width,s.height=l.height,g.drawImage(l,0,0),g.font=`${n}px ${i}`,g.fillStyle=h,g.globalAlpha=c;const d=g.measureText(t).width,C=n;let k,b;switch(u){case"top-left":k=10,b=C+10;break;case"top-right":k=l.width-d-10,b=C+10;break;case"bottom-left":k=10,b=l.height-10;break;case"bottom-right":k=l.width-d-10,b=l.height-10;break;case"center":k=(l.width-d)/2,b=(l.height+C)/2;break;default:k=l.width-d-10,b=l.height-10}return g.fillText(t,k,b),g.globalAlpha=1,s}function nt(l){const t=document.createElement("canvas"),o=t.getContext("2d");t.width=l.width,t.height=l.height,o.drawImage(l,0,0);const n=o.getImageData(0,0,l.width,l.height),i=n.data;for(let h=0;h<i.length;h+=4){const c=i[h]*.299+i[h+1]*.587+i[h+2]*.114;i[h]=c,i[h+1]=c,i[h+2]=c}return o.putImageData(n,0,0),t}const at={install:l=>{l.component("ElectronicSignature",z)},ElectronicSignature:z},ot="1.0.0";y.ElectronicSignature=z,y.PEN_STYLE_CONFIGS=F,y.SignatureReplayController=Z,y.addWatermark=tt,y.calculateStrokeWidth=j,y.cloneSignatureData=R,y.convertToGrayscale=nt,y.createDrawOptionsFromPenStyle=ne,y.createEmptySignatureData=O,y.createReplayData=ee,y.cropSignature=Ze,y.default=at,y.drawSmoothPath=_e,y.exportSignature=Q,y.getAllPenStyles=Ae,y.getAngle=H,y.getControlPoint=U,y.getDevicePixelRatio=ae,y.getDistance=E,y.getPenStyleConfig=te,y.getSignatureBounds=oe,y.isSignatureEmpty=V,y.loadImageToCanvas=K,y.resizeSignature=et,y.setupHighDPICanvas=Ke,y.signatureToSVG=G,y.version=ot,Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

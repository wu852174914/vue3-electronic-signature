(function(f,u){typeof exports=="object"&&typeof module<"u"?u(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],u):(f=typeof globalThis<"u"?globalThis:f||self,u(f.Vue3ElectronicSignature={},f.Vue))})(this,function(f,u){"use strict";var Pt=Object.defineProperty;var Mt=(f,u,W)=>u in f?Pt(f,u,{enumerable:!0,configurable:!0,writable:!0,value:W}):f[u]=W;var T=(f,u,W)=>(Mt(f,typeof u!="symbol"?u+"":u,W),W);function W(s,t){return Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))}function H(s,t){return Math.atan2(t.y-s.y,t.x-s.x)}function U(s,t,n,a){const o=t||s,i=n||s,r=.2,c=H(o,i)*(a?1:-1),h=W(o,i)*r;return{x:s.x+Math.cos(c)*h,y:s.y+Math.sin(c)*h,time:s.time}}function j(s,t,n){if(!n.pressure.enabled)return n.strokeWidth;const a=W(s,t),o=t.time-s.time,i=o>0?a/o:0,r=Math.max(.1,Math.min(1,1-i*.01)),{min:c,max:h}=n.pressure;return c+(h-c)*r}function Re(s,t,n){if(t.length<2)return;if(s.strokeStyle=n.strokeColor,s.lineCap="round",s.lineJoin="round",!n.smoothing||t.length<3){s.beginPath(),s.lineWidth=n.strokeWidth,s.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)s.lineTo(t[o].x,t[o].y);s.stroke();return}s.beginPath(),s.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length-1;o++){const i=t[o],r=t[o+1];n.pressure.enabled?s.lineWidth=j(t[o-1],i,n):s.lineWidth=n.strokeWidth;const c=U(i,t[o-1],r);s.quadraticCurveTo(c.x,c.y,i.x,i.y)}const a=t[t.length-1];s.lineTo(a.x,a.y),s.stroke()}function G(s){const{canvasSize:t,paths:n}=s;let a=`<svg width="${t.width}" height="${t.height}" xmlns="http://www.w3.org/2000/svg">`;return n.forEach(o=>{if(o.points.length<2)return;let i=`M ${o.points[0].x} ${o.points[0].y}`;for(let r=1;r<o.points.length;r++)i+=` L ${o.points[r].x} ${o.points[r].y}`;a+=`<path d="${i}" stroke="${o.strokeColor}" stroke-width="${o.strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),a+="</svg>",a}function Q(s,t,n={format:"png"}){const{format:a,quality:o=.9,size:i,backgroundColor:r}=n;if(a==="svg")return G(t);const c=document.createElement("canvas"),h=c.getContext("2d");if(i){c.width=i.width,c.height=i.height;const m=i.width/s.width,v=i.height/s.height;h.scale(m,v)}else c.width=s.width,c.height=s.height;switch(r&&r!=="transparent"&&(h.fillStyle=r,h.fillRect(0,0,c.width,c.height)),h.drawImage(s,0,0),a){case"jpeg":return c.toDataURL("image/jpeg",o);case"base64":return c.toDataURL("image/png").split(",")[1];case"png":default:return c.toDataURL("image/png")}}function K(s,t){return new Promise((n,a)=>{const o=new Image;o.onload=()=>{const i=s.getContext("2d");i.clearRect(0,0,s.width,s.height),i.drawImage(o,0,0,s.width,s.height),n()},o.onerror=a,o.src=t})}function N(s){return s.paths.length===0||s.paths.every(t=>t.points.length===0)}function O(s,t){return{paths:[],canvasSize:{width:s,height:t},timestamp:Date.now(),isEmpty:!0}}function I(s){return JSON.parse(JSON.stringify(s))}class Z{constructor(t){T(this,"canvas");T(this,"ctx");T(this,"replayData",null);T(this,"state","idle");T(this,"currentTime",0);T(this,"speed",1);T(this,"animationId",null);T(this,"startTimestamp",0);T(this,"pausedTime",0);T(this,"options",{});T(this,"eventCallbacks",new Map);T(this,"lastRenderedTime",-1);T(this,"completedPaths",new Set);T(this,"offscreenCanvas",null);T(this,"offscreenCtx",null);T(this,"needsFullRedraw",!0);this.canvas=t,this.ctx=t.getContext("2d"),this.initializeOffscreenCanvas()}initializeOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d")}setReplayData(t,n={}){console.log("设置回放数据:",t),console.log("回放选项:",n),this.replayData=t,this.options={...n},this.speed=n.speed||t.speed||1,this.currentTime=n.startTime||0,this.state="idle",this.resetOptimizationState(),console.log("回放数据设置完成，路径数量:",t.paths.length),console.log("总时长:",t.totalDuration)}resetOptimizationState(){this.lastRenderedTime=-1,this.completedPaths.clear(),this.needsFullRedraw=!0,this.offscreenCanvas&&(this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height)}play(){if(console.log("播放方法调用，回放数据:",this.replayData),console.log("当前状态:",this.state),!this.replayData){console.error("没有回放数据，无法播放");return}if(this.replayData.totalDuration<=0){console.error("回放数据总时长为0，无法播放");return}if(this.replayData.paths.length===0){console.error("回放数据没有路径，无法播放");return}if(this.state==="playing"){console.log("已在播放中，忽略");return}this.state==="paused"?(console.log("从暂停状态恢复播放"),this.state="playing",this.startTimestamp=performance.now()-this.pausedTime,this.emit("replay-resume")):(console.log("开始新的播放"),this.state="playing",this.startTimestamp=performance.now(),this.pausedTime=0,this.currentTime=this.options.startTime||0,this.clearCanvas(),this.emit("replay-start")),this.animate()}pause(){this.state==="playing"&&(this.state="paused",this.pausedTime=performance.now()-this.startTimestamp,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.emit("replay-pause"))}stop(){this.state="stopped",this.currentTime=0,this.pausedTime=0,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clearCanvas(),this.emit("replay-stop")}seek(t){if(!this.replayData)return;const n=this.options.endTime||this.replayData.totalDuration;this.currentTime=Math.max(0,Math.min(t,n)),this.needsFullRedraw=!0,this.state==="playing"?this.startTimestamp=performance.now()-this.currentTime/this.speed:this.pausedTime=this.currentTime/this.speed,this.renderFrame(this.currentTime)}setSpeed(t){const n=this.state==="playing";n&&this.pause(),this.speed=Math.max(.1,Math.min(5,t)),this.emit("replay-speed-change",this.speed),n&&this.play()}getState(){return this.state}getCurrentTime(){return this.currentTime}getTotalDuration(){var t;return((t=this.replayData)==null?void 0:t.totalDuration)||0}getProgress(){const t=this.getTotalDuration();return t>0?this.currentTime/t:0}animate(){if(this.state!=="playing"||!this.replayData)return;const t=performance.now();this.currentTime=(t-this.startTimestamp)*this.speed;const n=this.options.endTime||this.replayData.totalDuration;if(this.currentTime>=n){this.currentTime=n,this.state="completed",this.renderFrame(this.currentTime),this.emit("replay-complete"),this.options.loop&&setTimeout(()=>{this.currentTime=this.options.startTime||0,this.play()},500);return}this.renderFrame(this.currentTime),this.emit("replay-progress",this.getProgress(),this.currentTime),this.animationId=requestAnimationFrame(()=>this.animate())}renderFrame(t){if(!this.replayData)return;this.needsFullRedraw||t<this.lastRenderedTime?(this.renderFullFrame(t),this.needsFullRedraw=!1):this.renderIncrementalFrame(t),this.lastRenderedTime=t}renderFullFrame(t){if(!this.replayData)return;this.clearCanvas(),this.completedPaths.clear();let n=!1;for(let a=0;a<this.replayData.paths.length;a++){const o=this.replayData.paths[a],i=o.startTime||0,r=o.endTime||i+(o.duration||0);if(t<i)break;if(t>=r){this.drawCompletePath(o),this.completedPaths.add(a),!n&&Math.abs(t-r)<32&&this.emit("replay-path-end",a,o);continue}n=!0;const c=Math.max(0,Math.min(1,(t-i)/Math.max(r-i,1)));c>0&&Math.abs(t-i)<32&&this.emit("replay-path-start",a,o),this.drawPartialPath(o,c);break}}renderIncrementalFrame(t){if(this.replayData)for(let n=0;n<this.replayData.paths.length;n++){const a=this.replayData.paths[n],o=a.startTime||0,i=a.endTime||o+(a.duration||0);if(t<o)break;if(t>=i){this.completedPaths.has(n)||(this.drawCompletePath(a),this.completedPaths.add(n),this.emit("replay-path-end",n,a));continue}this.renderActivePathOptimized(a,t,o,i,n);break}}renderActivePathOptimized(t,n,a,o,i){if(!this.offscreenCanvas||!this.offscreenCtx)return;const r=Math.max(0,Math.min(1,(n-a)/Math.max(o-a,1)));r>0&&Math.abs(n-a)<32&&this.emit("replay-path-start",i,t);const c=this.getPathBounds(t,r);c&&(this.ctx.clearRect(c.x-10,c.y-10,c.width+20,c.height+20),this.redrawCompletedPathsInBounds(c)),this.drawPartialPath(t,r)}getPathBounds(t,n){if(t.points.length===0)return null;const a=Math.ceil(t.points.length*n),o=t.points.slice(0,a);if(o.length===0)return null;let i=o[0].x,r=o[0].x,c=o[0].y,h=o[0].y;for(const m of o)i=Math.min(i,m.x),r=Math.max(r,m.x),c=Math.min(c,m.y),h=Math.max(h,m.y);return{x:i,y:c,width:r-i,height:h-c}}redrawCompletedPathsInBounds(t){if(this.replayData){for(let n=0;n<this.replayData.paths.length;n++)if(this.completedPaths.has(n)){const a=this.replayData.paths[n];this.pathIntersectsBounds(a,t)&&this.drawCompletePath(a)}}}pathIntersectsBounds(t,n){for(const a of t.points)if(a.x>=n.x&&a.x<=n.x+n.width&&a.y>=n.y&&a.y<=n.y+n.height)return!0;return!1}drawCompletePath(t){if(t.points.length<2)return;const n=t.penStyle||this.options.penStyle||"pen";this.drawStyledStrokeForReplay(t.points,n,t.strokeColor,t.strokeWidth)}drawPartialPath(t,n){if(t.points.length<2)return;const a=t.startTime||0,o=t.duration||0,i=a+o*n,r=this.getPointsUpToTime(t.points,a,i);if(r.length<2)return;const c=t.penStyle||this.options.penStyle||"pen";this.drawStyledStrokeForReplay(r,c,t.strokeColor,t.strokeWidth)}getPointsUpToTime(t,n,a){const o=[];for(let i=0;i<t.length;i++){const r=t[i],c=n+(r.relativeTime||i*50);if(c<=a)o.push(r);else{if(i>0){const h=t[i-1],m=n+(h.relativeTime||(i-1)*50);if(m<=a){const v=(a-m)/(c-m),d={x:h.x+(r.x-h.x)*v,y:h.y+(r.y-h.y)*v,time:a,pressure:h.pressure?h.pressure+(r.pressure||h.pressure-h.pressure)*v:r.pressure};o.push(d)}}break}}return o}calculateDynamicStrokeWidth(t,n,a,o){switch(a){case"pen":return 1;case"brush":if(n){const h=Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2)),m=Math.max(1,(t.time||0)-(n.time||0)),v=h/m,d=Math.max(.1,Math.min(3,100/Math.max(v,1))),w=t.pressure||.5,x=.8+Math.random()*.4;return Math.max(1,Math.min(20,o*d*(.3+w*1.4)*x))}return o;case"marker":return 12;case"pencil":const i=t.pressure||.5,r=.9+Math.random()*.2;return o*(.7+i*.6)*r;case"ballpoint":const c=t.pressure||.5;return o*(.8+c*.4);default:return o}}drawStyledStrokeForReplay(t,n,a,o){if(!(t.length<2))switch(this.ctx.strokeStyle=a,n){case"pen":if(this.ctx.lineWidth=1,this.ctx.lineCap="butt",this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y),t.length>=3){for(let i=1;i<t.length-1;i++){const r=this.getControlPoint(t[i],t[i-1],t[i+1]);this.ctx.quadraticCurveTo(r.x,r.y,t[i].x,t[i].y)}this.ctx.lineTo(t[t.length-1].x,t[t.length-1].y)}else for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i].x,t[i].y);this.ctx.stroke();break;case"brush":this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let i=1;i<t.length;i++){const r=t[i],c=t[i-1],h=this.calculateDynamicStrokeWidth(r,c,n,o);this.ctx.lineWidth=h,this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(r.x,r.y),this.ctx.stroke(),h>8&&Math.random()>.6&&(this.ctx.globalAlpha=.2,this.ctx.beginPath(),this.ctx.arc(r.x,r.y,h*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.globalAlpha=1)}break;case"marker":this.ctx.globalAlpha=.7,this.ctx.lineWidth=12,this.ctx.lineCap="square",this.ctx.lineJoin="bevel",this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i].x,t[i].y);this.ctx.stroke(),this.ctx.globalAlpha=.3,this.ctx.lineWidth=16,this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let i=1;i<t.length;i++)this.ctx.lineTo(t[i].x,t[i].y);this.ctx.stroke(),this.ctx.globalAlpha=1;break;case"pencil":this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let i=1;i<t.length;i++){const r=t[i],c=t[i-1],h=this.calculateDynamicStrokeWidth(r,c,n,o);this.ctx.lineWidth=h,this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(r.x,r.y),this.ctx.stroke();for(let m=0;m<3;m++)if(Math.random()>.5){this.ctx.globalAlpha=.2,this.ctx.lineWidth=h*.3;const v=(Math.random()-.5)*2,d=(Math.random()-.5)*2;this.ctx.beginPath(),this.ctx.moveTo(c.x+v,c.y+d),this.ctx.lineTo(r.x+v,r.y+d),this.ctx.stroke()}if(Math.random()>.8){this.ctx.globalAlpha=.4;for(let m=0;m<5;m++)this.ctx.beginPath(),this.ctx.arc(r.x+(Math.random()-.5)*3,r.y+(Math.random()-.5)*3,Math.random()*.8,0,Math.PI*2),this.ctx.fill()}}this.ctx.globalAlpha=1;break;case"ballpoint":this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let i=1;i<t.length;i++){const r=t[i],c=t[i-1],h=this.calculateDynamicStrokeWidth(r,c,n,o);if(Math.random()>.1){if(this.ctx.lineWidth=h,this.ctx.globalAlpha=Math.random()>.2?1:.7,this.ctx.beginPath(),i<t.length-1){const m=t[i+1],v=this.getControlPoint(r,c,m);this.ctx.moveTo(c.x,c.y),this.ctx.quadraticCurveTo(v.x,v.y,r.x,r.y)}else this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(r.x,r.y);this.ctx.stroke()}Math.random()>.95&&(this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(r.x,r.y,h*.8,0,Math.PI*2),this.ctx.fill())}this.ctx.globalAlpha=1;break}}getControlPoint(t,n,a){const i={length:Math.sqrt(Math.pow(a.x-n.x,2)+Math.pow(a.y-n.y,2)),angle:Math.atan2(a.y-n.y,a.x-n.x)},r=i.angle+Math.PI,c=i.length*.2;return{x:t.x+Math.cos(r)*c,y:t.y+Math.sin(r)*c,time:t.time||0}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}on(t,n){this.eventCallbacks.has(t)||this.eventCallbacks.set(t,[]),this.eventCallbacks.get(t).push(n)}off(t,n){if(this.eventCallbacks.has(t))if(n){const a=this.eventCallbacks.get(t),o=a.indexOf(n);o>-1&&a.splice(o,1)}else this.eventCallbacks.delete(t)}emit(t,...n){const a=this.eventCallbacks.get(t);a&&a.forEach(o=>o(...n))}destroy(){this.stop(),this.eventCallbacks.clear(),this.replayData=null}}function ee(s){const t=s.paths.map(h=>{const m=h.points.map((d,w)=>{var C;let x;if(d.time&&h.points[0].time)x=d.time-h.points[0].time;else if(w===0)x=0;else{const F=h.points[w-1],M=Math.sqrt(Math.pow(d.x-F.x,2)+Math.pow(d.y-F.y,2))/100*1e3;x=(((C=m[w-1])==null?void 0:C.relativeTime)||0)+Math.max(M,16)}return{...d,relativeTime:x}}),v=m.length>0?m[m.length-1].relativeTime:0;return{...h,points:m,duration:v}}),n=[];for(let h=0;h<t.length;h++){const m=t[h];let v;if(h===0)v=0;else{const x=n[h-1],C=Ie(s.paths[h-1].points,s.paths[h].points);v=x.endTime+C}const d=v+m.duration,w={...m,startTime:v,endTime:d};console.log(`路径 ${h}: 开始时间=${v}, 结束时间=${d}, 持续时间=${m.duration}`),n.push(w)}const a=n.length>0?n[n.length-1].endTime:0;console.log("回放数据生成完成:"),console.log("- 路径数量:",n.length),console.log("- 总时长:",a),console.log("- 路径详情:",n.map(h=>({startTime:h.startTime,endTime:h.endTime,duration:h.duration,pointCount:h.points.length})));const o=n.reduce((h,m)=>h+Ae(m.points),0),i=a>0?o/(a/1e3):0,r=n.slice(1).map((h,m)=>{const v=n[m];return h.startTime-v.endTime}),c=r.length>0?r.reduce((h,m)=>h+m,0)/r.length:0;return{paths:n,totalDuration:a,speed:1,metadata:{deviceType:_e(s),averageSpeed:i,totalDistance:o,averagePauseTime:c}}}function Ie(s,t){if(s.length===0||t.length===0)return 200;const n=s[s.length-1],a=t[0];if(n.time&&a.time)return Math.max(a.time-n.time,50);const o=Math.sqrt(Math.pow(a.x-n.x,2)+Math.pow(a.y-n.y,2));return Math.min(Math.max(o*2,100),1e3)}function _e(s){const t=s.paths.reduce((i,r)=>i+r.points.length,0),n=s.paths.length;if(t===0)return"touch";const a=t/n;return a>20?"touch":a<10?"mouse":s.paths.some(i=>i.points.some(r=>r.pressure!==void 0))?"pen":"touch"}function Ae(s){let t=0;for(let n=1;n<s.length;n++){const a=s[n].x-s[n-1].x,o=s[n].y-s[n-1].y;t+=Math.sqrt(a*a+o*o)}return t}const z={pen:{name:"钢笔",description:"极细线条，锐利精准，商务签名",strokeWidth:1,smoothing:!0,pressure:{enabled:!1,min:1,max:1},lineCap:"butt",lineJoin:"miter",recommendedColor:"#000080"},brush:{name:"毛笔",description:"粗细变化极大，传统书法效果",strokeWidth:8,smoothing:!0,pressure:{enabled:!0,min:1,max:16},lineCap:"round",lineJoin:"round",recommendedColor:"#2c3e50"},marker:{name:"马克笔",description:"超粗线条，荧光笔效果",strokeWidth:12,smoothing:!1,pressure:{enabled:!1,min:10,max:14},lineCap:"square",lineJoin:"bevel",recommendedColor:"#ff6b35"},pencil:{name:"铅笔",description:"粗糙纹理，素描效果",strokeWidth:3,smoothing:!1,pressure:{enabled:!0,min:2,max:5},lineCap:"round",lineJoin:"round",recommendedColor:"#666666"},ballpoint:{name:"圆珠笔",description:"细线条，轻微断续效果",strokeWidth:1.2,smoothing:!0,pressure:{enabled:!0,min:.8,max:1.8},lineCap:"round",lineJoin:"round",recommendedColor:"#1e3a8a"}};function te(s){return z[s]}function Fe(){return Object.entries(z).map(([s,t])=>({key:s,config:t}))}function ae(s,t){const n=te(s);return{strokeWidth:n.strokeWidth,smoothing:n.smoothing,pressure:n.pressure,lineCap:n.lineCap,lineJoin:n.lineJoin,strokeColor:t||n.recommendedColor||"#000000"}}const Ne=["width","height"],Oe={key:1,class:"signature-toolbar"},Ve=["disabled"],Be=["disabled"],Je=["disabled"],$e={key:2,class:"replay-controls"},ze={class:"replay-buttons"},qe=["disabled"],Ye={key:0},Xe={key:1},Le=["disabled"],He={class:"replay-progress"},Ue=["max","value","disabled"],je={class:"time-display"},Ge={class:"replay-speed"},Qe=u.defineComponent({__name:"ElectronicSignature",props:{showToolbar:{type:Boolean,default:!1},width:{default:"100%"},height:{default:300},penStyle:{default:"pen"},strokeColor:{default:"#000000"},strokeWidth:{default:2},backgroundColor:{default:"transparent"},disabled:{type:Boolean,default:!1},placeholder:{default:"请在此处签名"},smoothing:{type:Boolean,default:!0},pressureSensitive:{type:Boolean,default:!1},minStrokeWidth:{default:1},maxStrokeWidth:{default:4},borderStyle:{default:"1px solid #ddd"},borderRadius:{default:"4px"},replayMode:{type:Boolean},replayData:{},replayOptions:{}},emits:["signature-start","signature-drawing","signature-end","signature-clear","signature-undo","signature-redo","replay-start","replay-progress","replay-pause","replay-resume","replay-stop","replay-complete","replay-path-start","replay-path-end","replay-speed-change"],setup(s,{expose:t,emit:n}){const a=s,o=n,i=u.ref(),r=u.ref(!1),c=u.ref(null),h=u.ref(O(0,0)),m=u.ref([]),v=u.ref(-1),d=u.ref(null),w=u.ref(!1),x=u.ref("idle"),C=u.ref(0),F=u.ref(0),D=u.computed(()=>typeof a.width=="number"?a.width:800),M=u.computed(()=>typeof a.height=="number"?a.height:300),it=u.computed(()=>({position:"relative",display:"inline-block",width:typeof a.width=="string"?a.width:`${a.width}px`,height:typeof a.height=="string"?a.height:`${a.height}px`})),lt=u.computed(()=>({border:a.borderStyle,borderRadius:a.borderRadius,backgroundColor:a.backgroundColor,cursor:a.disabled?"not-allowed":"crosshair",display:"block",width:"100%",height:"100%"})),st=u.computed(()=>({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#999",fontSize:"14px",pointerEvents:"none",userSelect:"none"})),rt=u.computed(()=>w.value?!1:a.placeholder&&N(h.value)),ie=u.computed(()=>v.value>0),le=u.computed(()=>v.value<m.value.length-1),se=u.computed(()=>w.value&&d.value),E=u.computed(()=>!se.value&&!a.disabled),ht=u.computed(()=>{var e;return se.value&&((e=a.replayOptions)==null?void 0:e.showControls)!==!1}),R=u.computed(()=>{if(a.penStyle){const e=ae(a.penStyle,a.strokeColor);return{strokeColor:e.strokeColor,strokeWidth:a.strokeWidth||e.strokeWidth,smoothing:a.smoothing!==void 0?a.smoothing:e.smoothing,pressure:{enabled:a.pressureSensitive!==void 0?a.pressureSensitive:e.pressure.enabled,min:a.minStrokeWidth||e.pressure.min,max:a.maxStrokeWidth||e.pressure.max},lineCap:e.lineCap,lineJoin:e.lineJoin}}return{strokeColor:a.strokeColor||"#000000",strokeWidth:a.strokeWidth||2,smoothing:a.smoothing!==void 0?a.smoothing:!0,pressure:{enabled:a.pressureSensitive||!1,min:a.minStrokeWidth||1,max:a.maxStrokeWidth||4},lineCap:"round",lineJoin:"round"}}),re=()=>{var e;return((e=i.value)==null?void 0:e.getContext("2d"))||null},V=(e,l)=>{const g=i.value,b=g.getBoundingClientRect(),p=g.width/b.width,y=g.height/b.height;return{x:(e-b.left)*p,y:(l-b.top)*y,time:Date.now()}},he=e=>{if(!E.value)return;r.value=!0;const l=performance.now(),g={...e,time:l};c.value={points:[g],strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,penStyle:a.penStyle,startTime:l,endTime:l,duration:0},o("signature-start")},Y=(e,l,g,b)=>{switch(g){case"pen":return 1;case"brush":if(l){const S=Math.sqrt(Math.pow(e.x-l.x,2)+Math.pow(e.y-l.y,2)),P=Math.max(1,(e.time||0)-(l.time||0)),A=S/P,$=Math.max(.1,Math.min(3,100/Math.max(A,1))),wt=e.pressure||.5,Ct=.8+Math.random()*.4;return Math.max(1,Math.min(20,b*$*(.3+wt*1.4)*Ct))}return b;case"marker":return 12;case"pencil":const p=e.pressure||.5,y=.9+Math.random()*.2;return b*(.7+p*.6)*y;case"ballpoint":const k=e.pressure||.5;return b*(.8+k*.4);default:return b}},X=(e,l,g)=>{var b;if(!(l.length<2))switch(e.strokeStyle=((b=c.value)==null?void 0:b.strokeColor)||R.value.strokeColor,e.lineCap=R.value.lineCap||"round",e.lineJoin=R.value.lineJoin||"round",g){case"pen":if(e.lineWidth=1,e.lineCap="butt",e.lineJoin="miter",e.beginPath(),e.moveTo(l[0].x,l[0].y),l.length>=3){for(let p=1;p<l.length-1;p++){const y=ce(l[p],l[p-1],l[p+1]);e.quadraticCurveTo(y.x,y.y,l[p].x,l[p].y)}e.lineTo(l[l.length-1].x,l[l.length-1].y)}else for(let p=1;p<l.length;p++)e.lineTo(l[p].x,l[p].y);e.stroke();break;case"brush":e.lineCap="round",e.lineJoin="round";for(let p=1;p<l.length;p++){const y=l[p],k=l[p-1],S=Y(y,k,g,R.value.strokeWidth),P=e.createLinearGradient(k.x,k.y,y.x,y.y);P.addColorStop(0,e.strokeStyle),P.addColorStop(1,e.strokeStyle),e.lineWidth=S,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(y.x,y.y),e.stroke(),S>8&&Math.random()>.6&&(e.globalAlpha=.2,e.beginPath(),e.arc(y.x,y.y,S*.3,0,Math.PI*2),e.fill(),e.globalAlpha=1)}break;case"marker":e.globalAlpha=.7,e.lineWidth=12,e.lineCap="square",e.lineJoin="bevel",e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let p=1;p<l.length;p++)e.lineTo(l[p].x,l[p].y);e.stroke(),e.globalAlpha=.3,e.lineWidth=16,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let p=1;p<l.length;p++)e.lineTo(l[p].x,l[p].y);e.stroke(),e.globalAlpha=1;break;case"pencil":e.lineCap="round",e.lineJoin="round";for(let p=1;p<l.length;p++){const y=l[p],k=l[p-1],S=Y(y,k,g,R.value.strokeWidth);e.lineWidth=S,e.globalAlpha=.8,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(y.x,y.y),e.stroke();for(let P=0;P<3;P++)if(Math.random()>.5){e.globalAlpha=.2,e.lineWidth=S*.3;const A=(Math.random()-.5)*2,$=(Math.random()-.5)*2;e.beginPath(),e.moveTo(k.x+A,k.y+$),e.lineTo(y.x+A,y.y+$),e.stroke()}if(Math.random()>.8){e.globalAlpha=.4;for(let P=0;P<5;P++)e.beginPath(),e.arc(y.x+(Math.random()-.5)*3,y.y+(Math.random()-.5)*3,Math.random()*.8,0,Math.PI*2),e.fill()}}e.globalAlpha=1;break;case"ballpoint":e.lineCap="round",e.lineJoin="round";for(let p=1;p<l.length;p++){const y=l[p],k=l[p-1],S=Y(y,k,g,R.value.strokeWidth);if(Math.random()>.1){if(e.lineWidth=S,e.globalAlpha=Math.random()>.2?1:.7,e.beginPath(),R.value.smoothing&&p<l.length-1){const P=l[p+1],A=ce(y,k,P);e.moveTo(k.x,k.y),e.quadraticCurveTo(A.x,A.y,y.x,y.y)}else e.moveTo(k.x,k.y),e.lineTo(y.x,y.y);e.stroke()}Math.random()>.95&&(e.globalAlpha=.8,e.beginPath(),e.arc(y.x,y.y,S*.8,0,Math.PI*2),e.fill())}e.globalAlpha=1;break}},ct=()=>{if(!c.value||c.value.points.length<2)return;const e=re();if(!e)return;const l=c.value.points,g=l.length,b=a.penStyle||"pen";if(g===2)X(e,l,b);else if(g>=3){const p=l.slice(-3);X(e,p,b)}},ce=(e,l,g)=>{const p={length:Math.sqrt(Math.pow(g.x-l.x,2)+Math.pow(g.y-l.y,2)),angle:Math.atan2(g.y-l.y,g.x-l.x)},y=p.angle+Math.PI,k=p.length*.2;return{x:e.x+Math.cos(y)*k,y:e.y+Math.sin(y)*k,time:e.time||0}},ut=(e,l)=>{if(l.points.length<2)return;const g=l.penStyle||a.penStyle||"pen",b=c.value;c.value=l,X(e,l.points,g),c.value=b},ue=e=>{if(!r.value||!c.value||!E.value)return;const l=performance.now(),g={...e,time:l};c.value.points.push(g),c.value.startTime&&(c.value.endTime=l,c.value.duration=l-c.value.startTime),ct(),ge(),o("signature-drawing",h.value)},de=()=>{if(!(!r.value||!c.value)){if(r.value=!1,c.value.points.length>0){const e=c.value.points[c.value.points.length-1];e.time&&c.value.startTime&&(c.value.endTime=e.time,c.value.duration=e.time-c.value.startTime)}h.value.paths.push(c.value),h.value.isEmpty=!1,h.value.timestamp=Date.now(),B(),_(),c.value=null,o("signature-end",h.value)}},dt=e=>{e.preventDefault();const l=V(e.clientX,e.clientY);he(l)},mt=e=>{if(e.preventDefault(),!r.value)return;const l=V(e.clientX,e.clientY);ue(l)},me=e=>{e.preventDefault(),de()},pt=e=>{if(e.preventDefault(),e.touches.length!==1)return;const l=e.touches[0],g=V(l.clientX,l.clientY);he(g)},gt=e=>{if(e.preventDefault(),e.touches.length!==1||!r.value)return;const l=e.touches[0],g=V(l.clientX,l.clientY);ue(g)},pe=e=>{e.preventDefault(),de()},ge=()=>{h.value.canvasSize={width:D.value,height:M.value},h.value.isEmpty=N(h.value)},B=()=>{m.value=m.value.slice(0,v.value+1),m.value.push(I(h.value)),v.value=m.value.length-1;const e=50;m.value.length>e&&(m.value=m.value.slice(-e),v.value=m.value.length-1)},_=()=>{const e=re();e&&(e.clearRect(0,0,D.value,M.value),a.backgroundColor&&a.backgroundColor!=="transparent"&&(e.fillStyle=a.backgroundColor,e.fillRect(0,0,D.value,M.value)),h.value.paths.forEach(l=>{l.points.length>0&&ut(e,l)}))},J=()=>{if(console.log("初始化回放控制器"),console.log("canvas引用是否存在:",!!i.value),!i.value){console.error("canvas引用不存在，无法初始化回放控制器");return}d.value&&(console.log("销毁现有回放控制器"),d.value.destroy()),console.log("创建新的回放控制器"),d.value=new Z(i.value),console.log("回放控制器创建成功:",!!d.value),d.value.on("replay-start",()=>{x.value="playing",o("replay-start")}),d.value.on("replay-progress",(e,l)=>{C.value=e,F.value=l,o("replay-progress",e,l)}),d.value.on("replay-pause",()=>{x.value="paused",o("replay-pause")}),d.value.on("replay-resume",()=>{x.value="playing",o("replay-resume")}),d.value.on("replay-stop",()=>{x.value="stopped",o("replay-stop")}),d.value.on("replay-complete",()=>{x.value="completed",o("replay-complete")}),d.value.on("replay-path-start",(e,l)=>{o("replay-path-start",e,l)}),d.value.on("replay-path-end",(e,l)=>{o("replay-path-end",e,l)}),d.value.on("replay-speed-change",e=>{o("replay-speed-change",e)})},fe=(e,l)=>{if(d.value||J(),d.value){w.value=!0;const g={...l,drawOptions:R.value,penStyle:a.penStyle};d.value.setReplayData(e,g),console.log("startReplay调用，自动播放:",l==null?void 0:l.autoPlay),(l==null?void 0:l.autoPlay)===!0&&d.value.play()}},ye=e=>{w.value=e,!e&&d.value&&(d.value.stop(),_())},ft=()=>N(h.value)?null:ee(h.value),ve=()=>{console.log("play方法被调用"),console.log("回放控制器是否存在:",!!d.value),d.value||(console.log("回放控制器不存在，尝试初始化"),J()),d.value?(console.log("调用回放控制器的play方法"),d.value.play()):console.error("回放控制器初始化失败，无法播放")},xe=()=>{var e;(e=d.value)==null||e.pause()},be=()=>{var e;(e=d.value)==null||e.stop()},ke=e=>{var l;(l=d.value)==null||l.seek(e)},Te=e=>{var l;(l=d.value)==null||l.setSpeed(e)},yt=()=>{var e;return((e=d.value)==null?void 0:e.getState())||"idle"},vt=()=>{var e;return((e=d.value)==null?void 0:e.getCurrentTime())||0},L=()=>{var e;return((e=d.value)==null?void 0:e.getTotalDuration())||0},xt=()=>{var e;return((e=d.value)==null?void 0:e.getProgress())||0},we=e=>{const l=Math.floor(e/1e3),g=Math.floor(l/60),b=l%60;return`${g}:${b.toString().padStart(2,"0")}`},Ce=()=>{E.value&&(h.value=O(D.value,M.value),_(),B(),o("signature-clear"))},Pe=()=>{!ie.value||!E.value||(v.value--,h.value=I(m.value[v.value]),_(),o("signature-undo",h.value))},Me=()=>{!le.value||!E.value||(v.value++,h.value=I(m.value[v.value]),_(),o("signature-redo",h.value))},Se=e=>{const l=i.value;return Q(l,h.value,e)},De=()=>N(h.value),Ee=async e=>{if(!E.value)return;const l=i.value;await K(l,e),h.value=O(D.value,M.value),h.value.isEmpty=!1,B()},bt=()=>I(h.value),kt=e=>{E.value&&(h.value=I(e),_(),B())},We=(e,l)=>{const g=e||D.value,b=l||M.value,p=Se({format:"png"});u.nextTick(()=>{const y=i.value;y.width=g,y.height=b,De()||Ee(p),ge()})},Tt=()=>{const e=i.value;e.width=D.value,e.height=M.value,h.value=O(D.value,M.value),m.value=[I(h.value)],v.value=0,_()};return u.watch([()=>a.width,()=>a.height],()=>{u.nextTick(()=>{i.value&&We()})}),u.watch(()=>a.replayMode,e=>{e!==void 0&&ye(e)}),u.watch(()=>a.replayData,e=>{if(console.log("watch监听到回放数据变化:",e),console.log("当前回放模式:",a.replayMode),console.log("回放控制器是否存在:",!!d.value),e&&a.replayMode)if(d.value||(console.log("回放控制器未初始化，先初始化"),J()),d.value){console.log("开始设置回放数据到控制器");const l={...a.replayOptions,drawOptions:R.value,penStyle:a.penStyle};d.value.setReplayData(e,l),console.log("回放数据已更新:",e)}else console.error("回放控制器初始化失败");else e||console.log("回放数据为空，跳过设置"),a.replayMode||console.log("不在回放模式，跳过设置")},{immediate:!0}),u.onMounted(()=>{u.nextTick(()=>{Tt(),J(),a.replayMode&&a.replayData&&fe(a.replayData,a.replayOptions)})}),u.onUnmounted(()=>{d.value&&(d.value.destroy(),d.value=null)}),t({clear:Ce,undo:Pe,redo:Me,save:Se,isEmpty:De,fromDataURL:Ee,getSignatureData:bt,setSignatureData:kt,resize:We,startReplay:fe,getReplayData:ft,setReplayMode:ye,play:ve,pause:xe,stop:be,seek:ke,setSpeed:Te,getState:yt,getCurrentTime:vt,getTotalDuration:L,getProgress:xt}),(e,l)=>(u.openBlock(),u.createElementBlock("div",{class:"electronic-signature",style:u.normalizeStyle(it.value)},[u.createElementVNode("canvas",{ref_key:"canvasRef",ref:i,width:D.value,height:M.value,style:u.normalizeStyle(lt.value),onMousedown:dt,onMousemove:mt,onMouseup:me,onMouseleave:me,onTouchstart:pt,onTouchmove:gt,onTouchend:pe,onTouchcancel:pe},null,44,Ne),rt.value?(u.openBlock(),u.createElementBlock("div",{key:0,class:"signature-placeholder",style:u.normalizeStyle(st.value)},u.toDisplayString(e.placeholder),5)):u.createCommentVNode("",!0),e.showToolbar?(u.openBlock(),u.createElementBlock("div",Oe,[u.createElementVNode("button",{onClick:Ce,disabled:!E.value},"清除",8,Ve),u.createElementVNode("button",{onClick:Pe,disabled:!E.value||!ie.value},"撤销",8,Be),u.createElementVNode("button",{onClick:Me,disabled:!E.value||!le.value},"重做",8,Je)])):u.createCommentVNode("",!0),ht.value?(u.openBlock(),u.createElementBlock("div",$e,[u.createElementVNode("div",ze,[u.createElementVNode("button",{onClick:l[0]||(l[0]=g=>x.value==="playing"?xe():ve()),disabled:x.value==="idle",class:"replay-btn play-pause-btn"},[x.value==="playing"?(u.openBlock(),u.createElementBlock("span",Ye,"⏸️")):(u.openBlock(),u.createElementBlock("span",Xe,"▶️"))],8,qe),u.createElementVNode("button",{onClick:l[1]||(l[1]=g=>be()),disabled:x.value==="idle",class:"replay-btn stop-btn"}," ⏹️ ",8,Le)]),u.createElementVNode("div",He,[u.createElementVNode("input",{type:"range",min:"0",max:L(),value:F.value,onInput:l[2]||(l[2]=g=>ke(Number(g.target.value))),class:"progress-slider",disabled:x.value==="idle"},null,40,Ue),u.createElementVNode("div",je,[u.createElementVNode("span",null,u.toDisplayString(we(F.value)),1),l[4]||(l[4]=u.createElementVNode("span",null,"/",-1)),u.createElementVNode("span",null,u.toDisplayString(we(L())),1)])]),u.createElementVNode("div",Ge,[l[6]||(l[6]=u.createElementVNode("label",null,"速度:",-1)),u.createElementVNode("select",{onChange:l[3]||(l[3]=g=>Te(Number(g.target.value))),class:"speed-select"},l[5]||(l[5]=[u.createElementVNode("option",{value:"0.5"},"0.5x",-1),u.createElementVNode("option",{value:"1",selected:""},"1x",-1),u.createElementVNode("option",{value:"1.5"},"1.5x",-1),u.createElementVNode("option",{value:"2"},"2x",-1)]),32)])])):u.createCommentVNode("",!0)],4))}}),St="",q=((s,t)=>{const n=s.__vccOpts||s;for(const[a,o]of t)n[a]=o;return n})(Qe,[["__scopeId","data-v-37d68792"]]);function ne(){return window.devicePixelRatio||1}function Ke(s){const t=s.getContext("2d"),n=ne(),a=s.clientWidth,o=s.clientHeight;return s.width=a*n,s.height=o*n,t.scale(n,n),s.style.width=a+"px",s.style.height=o+"px",t}function oe(s){if(s.paths.length===0)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let t=1/0,n=1/0,a=-1/0,o=-1/0;return s.paths.forEach(i=>{i.points.forEach(r=>{t=Math.min(t,r.x),n=Math.min(n,r.y),a=Math.max(a,r.x),o=Math.max(o,r.y)})}),{minX:t,minY:n,maxX:a,maxY:o,width:a-t,height:o-n}}function Ze(s,t,n=10){const a=oe(t);if(a.width===0||a.height===0){const h=document.createElement("canvas");return h.width=1,h.height=1,h}const o=document.createElement("canvas"),i=o.getContext("2d"),r=a.width+n*2,c=a.height+n*2;return o.width=r,o.height=c,i.drawImage(s,a.minX-n,a.minY-n,r,c,0,0,r,c),o}function et(s,t,n,a=!0){const o=document.createElement("canvas"),i=o.getContext("2d");let r=t,c=n;if(a){const h=s.width/s.height,m=t/n;h>m?c=t/h:r=n*h}return o.width=r,o.height=c,i.imageSmoothingEnabled=!0,i.imageSmoothingQuality="high",i.drawImage(s,0,0,r,c),o}function tt(s,t,n={}){const{fontSize:a=12,fontFamily:o="Arial",color:i="#999",opacity:r=.5,position:c="bottom-right"}=n,h=document.createElement("canvas"),m=h.getContext("2d");h.width=s.width,h.height=s.height,m.drawImage(s,0,0),m.font=`${a}px ${o}`,m.fillStyle=i,m.globalAlpha=r;const d=m.measureText(t).width,w=a;let x,C;switch(c){case"top-left":x=10,C=w+10;break;case"top-right":x=s.width-d-10,C=w+10;break;case"bottom-left":x=10,C=s.height-10;break;case"bottom-right":x=s.width-d-10,C=s.height-10;break;case"center":x=(s.width-d)/2,C=(s.height+w)/2;break;default:x=s.width-d-10,C=s.height-10}return m.fillText(t,x,C),m.globalAlpha=1,h}function at(s){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=s.width,t.height=s.height,n.drawImage(s,0,0);const a=n.getImageData(0,0,s.width,s.height),o=a.data;for(let i=0;i<o.length;i+=4){const r=o[i]*.299+o[i+1]*.587+o[i+2]*.114;o[i]=r,o[i+1]=r,o[i+2]=r}return n.putImageData(a,0,0),t}const nt={install:s=>{s.component("ElectronicSignature",q)},ElectronicSignature:q},ot="1.0.0";f.ElectronicSignature=q,f.PEN_STYLE_CONFIGS=z,f.SignatureReplayController=Z,f.addWatermark=tt,f.calculateStrokeWidth=j,f.cloneSignatureData=I,f.convertToGrayscale=at,f.createDrawOptionsFromPenStyle=ae,f.createEmptySignatureData=O,f.createReplayData=ee,f.cropSignature=Ze,f.default=nt,f.drawSmoothPath=Re,f.exportSignature=Q,f.getAllPenStyles=Fe,f.getAngle=H,f.getControlPoint=U,f.getDevicePixelRatio=ne,f.getDistance=W,f.getPenStyleConfig=te,f.getSignatureBounds=oe,f.isSignatureEmpty=N,f.loadImageToCanvas=K,f.resizeSignature=et,f.setupHighDPICanvas=Ke,f.signatureToSVG=G,f.version=ot,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

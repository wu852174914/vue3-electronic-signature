(function(f,u){typeof exports=="object"&&typeof module<"u"?u(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],u):(f=typeof globalThis<"u"?globalThis:f||self,u(f.Vue3ElectronicSignature={},f.Vue))})(this,function(f,u){"use strict";var St=Object.defineProperty;var Mt=(f,u,E)=>u in f?St(f,u,{enumerable:!0,configurable:!0,writable:!0,value:E}):f[u]=E;var w=(f,u,E)=>(Mt(f,typeof u!="symbol"?u+"":u,E),E);function E(i,t){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}function H(i,t){return Math.atan2(t.y-i.y,t.x-i.x)}function U(i,t,o,a){const l=t||i,s=o||i,h=.2,c=H(l,s)*(a?1:-1),r=E(l,s)*h;return{x:i.x+Math.cos(c)*r,y:i.y+Math.sin(c)*r,time:i.time}}function j(i,t,o){if(!o.pressure.enabled)return o.strokeWidth;const a=E(i,t),l=t.time-i.time,s=l>0?a/l:0,h=Math.max(.1,Math.min(1,1-s*.01)),{min:c,max:r}=o.pressure;return c+(r-c)*h}function _e(i,t,o){if(t.length<2)return;if(i.strokeStyle=o.strokeColor,i.lineCap="round",i.lineJoin="round",!o.smoothing||t.length<3){i.beginPath(),i.lineWidth=o.strokeWidth,i.moveTo(t[0].x,t[0].y);for(let l=1;l<t.length;l++)i.lineTo(t[l].x,t[l].y);i.stroke();return}i.beginPath(),i.moveTo(t[0].x,t[0].y);for(let l=1;l<t.length-1;l++){const s=t[l],h=t[l+1];o.pressure.enabled?i.lineWidth=j(t[l-1],s,o):i.lineWidth=o.strokeWidth;const c=U(s,t[l-1],h);i.quadraticCurveTo(c.x,c.y,s.x,s.y)}const a=t[t.length-1];i.lineTo(a.x,a.y),i.stroke()}function G(i){const{canvasSize:t,paths:o}=i;let a=`<svg width="${t.width}" height="${t.height}" xmlns="http://www.w3.org/2000/svg">`;return o.forEach(l=>{if(l.points.length<2)return;let s=`M ${l.points[0].x} ${l.points[0].y}`;for(let h=1;h<l.points.length;h++)s+=` L ${l.points[h].x} ${l.points[h].y}`;a+=`<path d="${s}" stroke="${l.strokeColor}" stroke-width="${l.strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),a+="</svg>",a}function Q(i,t,o={format:"png"}){const{format:a,quality:l=.9,size:s,backgroundColor:h}=o;if(a==="svg")return G(t);const c=document.createElement("canvas"),r=c.getContext("2d");if(s){c.width=s.width,c.height=s.height;const m=s.width/i.width,v=s.height/i.height;r.scale(m,v)}else c.width=i.width,c.height=i.height;switch(h&&h!=="transparent"&&(r.fillStyle=h,r.fillRect(0,0,c.width,c.height)),r.drawImage(i,0,0),a){case"jpeg":return c.toDataURL("image/jpeg",l);case"base64":return c.toDataURL("image/png").split(",")[1];case"png":default:return c.toDataURL("image/png")}}function K(i,t){return new Promise((o,a)=>{const l=new Image;l.onload=()=>{const s=i.getContext("2d");s.clearRect(0,0,i.width,i.height),s.drawImage(l,0,0,i.width,i.height),o()},l.onerror=a,l.src=t})}function N(i){return i.paths.length===0||i.paths.every(t=>t.points.length===0)}function V(i,t){return{paths:[],canvasSize:{width:i,height:t},timestamp:Date.now(),isEmpty:!0}}function R(i){return JSON.parse(JSON.stringify(i))}class Z{constructor(t){w(this,"canvas");w(this,"ctx");w(this,"replayData",null);w(this,"state","idle");w(this,"currentTime",0);w(this,"speed",1);w(this,"animationId",null);w(this,"startTimestamp",0);w(this,"pausedTime",0);w(this,"options",{});w(this,"eventCallbacks",new Map);w(this,"offscreenCanvas",null);w(this,"offscreenCtx",null);this.canvas=t,this.ctx=t.getContext("2d"),this.initializeOffscreenCanvas()}initializeOffscreenCanvas(){this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d")}setReplayData(t,o={}){console.log("设置回放数据:",t),console.log("回放选项:",o),this.replayData=t,this.options={...o},this.speed=o.speed||t.speed||1,this.currentTime=o.startTime||0,this.state="idle",this.resetOptimizationState(),console.log("回放数据设置完成，路径数量:",t.paths.length),console.log("总时长:",t.totalDuration)}resetOptimizationState(){this.offscreenCanvas&&(this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height)}play(){if(console.log("播放方法调用，回放数据:",this.replayData),console.log("当前状态:",this.state),!this.replayData){console.error("没有回放数据，无法播放");return}if(this.replayData.totalDuration<=0){console.error("回放数据总时长为0，无法播放");return}if(this.replayData.paths.length===0){console.error("回放数据没有路径，无法播放");return}if(this.state==="playing"){console.log("已在播放中，忽略");return}this.state==="paused"?(console.log("从暂停状态恢复播放"),this.state="playing",this.startTimestamp=performance.now()-this.pausedTime,this.emit("replay-resume")):(console.log("开始新的播放"),this.state="playing",this.startTimestamp=performance.now(),this.pausedTime=0,this.currentTime=this.options.startTime||0,this.clearCanvas(),this.emit("replay-start")),this.animate()}pause(){this.state==="playing"&&(this.state="paused",this.pausedTime=performance.now()-this.startTimestamp,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.emit("replay-pause"))}stop(){this.state="stopped",this.currentTime=0,this.pausedTime=0,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clearCanvas(),this.emit("replay-stop")}seek(t){if(!this.replayData)return;const o=this.options.endTime||this.replayData.totalDuration;this.currentTime=Math.max(0,Math.min(t,o)),this.state==="playing"?this.startTimestamp=performance.now()-this.currentTime/this.speed:this.pausedTime=this.currentTime/this.speed,this.renderFrame(this.currentTime)}setSpeed(t){const o=this.state==="playing";o&&this.pause(),this.speed=Math.max(.1,Math.min(5,t)),this.emit("replay-speed-change",this.speed),o&&this.play()}getState(){return this.state}getCurrentTime(){return this.currentTime}getTotalDuration(){var t;return((t=this.replayData)==null?void 0:t.totalDuration)||0}getProgress(){const t=this.getTotalDuration();return t>0?this.currentTime/t:0}animate(){if(this.state!=="playing"||!this.replayData)return;const t=performance.now();this.currentTime=(t-this.startTimestamp)*this.speed;const o=this.options.endTime||this.replayData.totalDuration;if(this.currentTime>=o){this.currentTime=o,this.state="completed",this.renderFrame(this.currentTime),this.emit("replay-complete"),this.options.loop&&setTimeout(()=>{this.currentTime=this.options.startTime||0,this.play()},500);return}this.renderFrame(this.currentTime),this.emit("replay-progress",this.getProgress(),this.currentTime),this.animationId=requestAnimationFrame(()=>this.animate())}renderFrame(t){!this.replayData||!this.offscreenCanvas||!this.offscreenCtx||(this.renderToOffscreenCanvas(t),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.offscreenCanvas,0,0))}renderToOffscreenCanvas(t){if(!this.replayData||!this.offscreenCtx)return;this.offscreenCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height);let o=!1;for(let a=0;a<this.replayData.paths.length;a++){const l=this.replayData.paths[a],s=l.startTime||0,h=l.endTime||s+(l.duration||0);if(t<s)break;if(t>=h){this.drawCompletePathToOffscreen(l),!o&&Math.abs(t-h)<32&&this.emit("replay-path-end",a,l);continue}o=!0;const c=Math.max(0,Math.min(1,(t-s)/Math.max(h-s,1)));c>0&&Math.abs(t-s)<32&&this.emit("replay-path-start",a,l),this.drawPartialPathToOffscreen(l,c);break}}getPointsUpToTime(t,o,a){const l=[];for(let s=0;s<t.length;s++){const h=t[s],c=o+(h.relativeTime||s*50);if(c<=a)l.push(h);else{if(s>0){const r=t[s-1],m=o+(r.relativeTime||(s-1)*50);if(m<=a){const v=(a-m)/(c-m),d={x:r.x+(h.x-r.x)*v,y:r.y+(h.y-r.y)*v,time:a,pressure:r.pressure?r.pressure+(h.pressure||r.pressure-r.pressure)*v:h.pressure};l.push(d)}}break}}return l}calculateDynamicStrokeWidth(t,o,a,l){switch(a){case"pen":return 1;case"brush":if(o){const r=Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2)),m=Math.max(1,(t.time||0)-(o.time||0)),v=r/m,d=Math.max(.1,Math.min(3,100/Math.max(v,1))),b=t.pressure||.5,x=.8+Math.random()*.4;return Math.max(1,Math.min(20,l*d*(.3+b*1.4)*x))}return l;case"marker":return 12;case"pencil":const s=t.pressure||.5,h=.9+Math.random()*.2;return l*(.7+s*.6)*h;case"ballpoint":const c=t.pressure||.5;return l*(.8+c*.4);default:return l}}drawStyledStrokeForReplay(t,o,a,l){if(!(t.length<2))switch(this.ctx.strokeStyle=a,o){case"pen":if(this.ctx.lineWidth=1,this.ctx.lineCap="butt",this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y),t.length>=3){for(let s=1;s<t.length-1;s++){const h=this.getControlPoint(t[s],t[s-1],t[s+1]);this.ctx.quadraticCurveTo(h.x,h.y,t[s].x,t[s].y)}this.ctx.lineTo(t[t.length-1].x,t[t.length-1].y)}else for(let s=1;s<t.length;s++)this.ctx.lineTo(t[s].x,t[s].y);this.ctx.stroke();break;case"brush":this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let s=1;s<t.length;s++){const h=t[s],c=t[s-1],r=this.calculateDynamicStrokeWidth(h,c,o,l);this.ctx.lineWidth=r,this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(h.x,h.y),this.ctx.stroke(),r>8&&Math.random()>.6&&(this.ctx.globalAlpha=.2,this.ctx.beginPath(),this.ctx.arc(h.x,h.y,r*.3,0,Math.PI*2),this.ctx.fill(),this.ctx.globalAlpha=1)}break;case"marker":this.ctx.globalAlpha=.7,this.ctx.lineWidth=12,this.ctx.lineCap="square",this.ctx.lineJoin="bevel",this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)this.ctx.lineTo(t[s].x,t[s].y);this.ctx.stroke(),this.ctx.globalAlpha=.3,this.ctx.lineWidth=16,this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let s=1;s<t.length;s++)this.ctx.lineTo(t[s].x,t[s].y);this.ctx.stroke(),this.ctx.globalAlpha=1;break;case"pencil":this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let s=1;s<t.length;s++){const h=t[s],c=t[s-1],r=this.calculateDynamicStrokeWidth(h,c,o,l);this.ctx.lineWidth=r,this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(h.x,h.y),this.ctx.stroke();for(let m=0;m<3;m++)if(Math.random()>.5){this.ctx.globalAlpha=.2,this.ctx.lineWidth=r*.3;const v=(Math.random()-.5)*2,d=(Math.random()-.5)*2;this.ctx.beginPath(),this.ctx.moveTo(c.x+v,c.y+d),this.ctx.lineTo(h.x+v,h.y+d),this.ctx.stroke()}if(Math.random()>.8){this.ctx.globalAlpha=.4;for(let m=0;m<5;m++)this.ctx.beginPath(),this.ctx.arc(h.x+(Math.random()-.5)*3,h.y+(Math.random()-.5)*3,Math.random()*.8,0,Math.PI*2),this.ctx.fill()}}this.ctx.globalAlpha=1;break;case"ballpoint":this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let s=1;s<t.length;s++){const h=t[s],c=t[s-1],r=this.calculateDynamicStrokeWidth(h,c,o,l);if(Math.random()>.1){if(this.ctx.lineWidth=r,this.ctx.globalAlpha=Math.random()>.2?1:.7,this.ctx.beginPath(),s<t.length-1){const m=t[s+1],v=this.getControlPoint(h,c,m);this.ctx.moveTo(c.x,c.y),this.ctx.quadraticCurveTo(v.x,v.y,h.x,h.y)}else this.ctx.moveTo(c.x,c.y),this.ctx.lineTo(h.x,h.y);this.ctx.stroke()}Math.random()>.95&&(this.ctx.globalAlpha=.8,this.ctx.beginPath(),this.ctx.arc(h.x,h.y,r*.8,0,Math.PI*2),this.ctx.fill())}this.ctx.globalAlpha=1;break}}getControlPoint(t,o,a){const s={length:Math.sqrt(Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2)),angle:Math.atan2(a.y-o.y,a.x-o.x)},h=s.angle+Math.PI,c=s.length*.2;return{x:t.x+Math.cos(h)*c,y:t.y+Math.sin(h)*c,time:t.time||0}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}on(t,o){this.eventCallbacks.has(t)||this.eventCallbacks.set(t,[]),this.eventCallbacks.get(t).push(o)}off(t,o){if(this.eventCallbacks.has(t))if(o){const a=this.eventCallbacks.get(t),l=a.indexOf(o);l>-1&&a.splice(l,1)}else this.eventCallbacks.delete(t)}emit(t,...o){const a=this.eventCallbacks.get(t);a&&a.forEach(l=>l(...o))}drawCompletePathToOffscreen(t){if(!this.offscreenCtx||t.points.length<2)return;const o=this.ctx;this.ctx=this.offscreenCtx;const a=t.penStyle||this.options.penStyle||"pen";this.drawStyledStrokeForReplay(t.points,a,t.strokeColor,t.strokeWidth),this.ctx=o}drawPartialPathToOffscreen(t,o){if(!this.offscreenCtx||t.points.length<2)return;const a=t.startTime||0,l=t.duration||0,s=a+l*o,h=this.getPointsUpToTime(t.points,a,s);if(h.length<2)return;const c=this.ctx;this.ctx=this.offscreenCtx;const r=t.penStyle||this.options.penStyle||"pen";this.drawStyledStrokeForReplay(h,r,t.strokeColor,t.strokeWidth),this.ctx=c}destroy(){this.stop(),this.eventCallbacks.clear(),this.replayData=null}}function ee(i){const t=i.paths.map(r=>{const m=r.points.map((d,b)=>{var k;let x;if(d.time&&r.points[0].time)x=d.time-r.points[0].time;else if(b===0)x=0;else{const O=r.points[b-1],M=Math.sqrt(Math.pow(d.x-O.x,2)+Math.pow(d.y-O.y,2))/100*1e3;x=(((k=m[b-1])==null?void 0:k.relativeTime)||0)+Math.max(M,16)}return{...d,relativeTime:x}}),v=m.length>0?m[m.length-1].relativeTime:0;return{...r,points:m,duration:v}}),o=[];for(let r=0;r<t.length;r++){const m=t[r];let v;if(r===0)v=0;else{const x=o[r-1],k=Re(i.paths[r-1].points,i.paths[r].points);v=x.endTime+k}const d=v+m.duration,b={...m,startTime:v,endTime:d};console.log(`路径 ${r}: 开始时间=${v}, 结束时间=${d}, 持续时间=${m.duration}`),o.push(b)}const a=o.length>0?o[o.length-1].endTime:0;console.log("回放数据生成完成:"),console.log("- 路径数量:",o.length),console.log("- 总时长:",a),console.log("- 路径详情:",o.map(r=>({startTime:r.startTime,endTime:r.endTime,duration:r.duration,pointCount:r.points.length})));const l=o.reduce((r,m)=>r+Ae(m.points),0),s=a>0?l/(a/1e3):0,h=o.slice(1).map((r,m)=>{const v=o[m];return r.startTime-v.endTime}),c=h.length>0?h.reduce((r,m)=>r+m,0)/h.length:0;return{paths:o,totalDuration:a,speed:1,metadata:{deviceType:Ie(i),averageSpeed:s,totalDistance:l,averagePauseTime:c}}}function Re(i,t){if(i.length===0||t.length===0)return 200;const o=i[i.length-1],a=t[0];if(o.time&&a.time)return Math.max(a.time-o.time,50);const l=Math.sqrt(Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2));return Math.min(Math.max(l*2,100),1e3)}function Ie(i){const t=i.paths.reduce((s,h)=>s+h.points.length,0),o=i.paths.length;if(t===0)return"touch";const a=t/o;return a>20?"touch":a<10?"mouse":i.paths.some(s=>s.points.some(h=>h.pressure!==void 0))?"pen":"touch"}function Ae(i){let t=0;for(let o=1;o<i.length;o++){const a=i[o].x-i[o-1].x,l=i[o].y-i[o-1].y;t+=Math.sqrt(a*a+l*l)}return t}const q={pen:{name:"钢笔",description:"极细线条，锐利精准，商务签名",strokeWidth:1,smoothing:!0,pressure:{enabled:!1,min:1,max:1},lineCap:"butt",lineJoin:"miter",recommendedColor:"#000080"},brush:{name:"毛笔",description:"粗细变化极大，传统书法效果",strokeWidth:8,smoothing:!0,pressure:{enabled:!0,min:1,max:16},lineCap:"round",lineJoin:"round",recommendedColor:"#2c3e50"},marker:{name:"马克笔",description:"超粗线条，荧光笔效果",strokeWidth:12,smoothing:!1,pressure:{enabled:!1,min:10,max:14},lineCap:"square",lineJoin:"bevel",recommendedColor:"#ff6b35"},pencil:{name:"铅笔",description:"粗糙纹理，素描效果",strokeWidth:3,smoothing:!1,pressure:{enabled:!0,min:2,max:5},lineCap:"round",lineJoin:"round",recommendedColor:"#666666"},ballpoint:{name:"圆珠笔",description:"细线条，轻微断续效果",strokeWidth:1.2,smoothing:!0,pressure:{enabled:!0,min:.8,max:1.8},lineCap:"round",lineJoin:"round",recommendedColor:"#1e3a8a"}};function te(i){return q[i]}function Oe(){return Object.entries(q).map(([i,t])=>({key:i,config:t}))}function ae(i,t){const o=te(i);return{strokeWidth:o.strokeWidth,smoothing:o.smoothing,pressure:o.pressure,lineCap:o.lineCap,lineJoin:o.lineJoin,strokeColor:t||o.recommendedColor||"#000000"}}const Ne=["width","height"],Ve={key:1,class:"signature-toolbar"},Je=["disabled"],Fe=["disabled"],$e=["disabled"],Be={key:2,class:"replay-controls"},qe={class:"replay-buttons"},ze=["disabled"],Ye={key:0},Xe={key:1},Le=["disabled"],He={class:"replay-progress"},Ue=["max","value","disabled"],je={class:"time-display"},Ge={class:"replay-speed"},Qe=u.defineComponent({__name:"ElectronicSignature",props:{showToolbar:{type:Boolean,default:!1},width:{default:"100%"},height:{default:300},penStyle:{default:"pen"},strokeColor:{default:"#000000"},strokeWidth:{default:2},backgroundColor:{default:"transparent"},disabled:{type:Boolean,default:!1},placeholder:{default:"请在此处签名"},smoothing:{type:Boolean,default:!0},pressureSensitive:{type:Boolean,default:!1},minStrokeWidth:{default:1},maxStrokeWidth:{default:4},borderStyle:{default:"1px solid #ddd"},borderRadius:{default:"4px"},replayMode:{type:Boolean},replayData:{},replayOptions:{}},emits:["signature-start","signature-drawing","signature-end","signature-clear","signature-undo","signature-redo","replay-start","replay-progress","replay-pause","replay-resume","replay-stop","replay-complete","replay-path-start","replay-path-end","replay-speed-change"],setup(i,{expose:t,emit:o}){const a=i,l=o,s=u.ref(),h=u.ref(!1),c=u.ref(null),r=u.ref(V(0,0)),m=u.ref([]),v=u.ref(-1),d=u.ref(null),b=u.ref(!1),x=u.ref("idle"),k=u.ref(0),O=u.ref(0),D=u.computed(()=>typeof a.width=="number"?a.width:800),M=u.computed(()=>typeof a.height=="number"?a.height:300),it=u.computed(()=>({position:"relative",display:"inline-block",width:typeof a.width=="string"?a.width:`${a.width}px`,height:typeof a.height=="string"?a.height:`${a.height}px`})),st=u.computed(()=>({border:a.borderStyle,borderRadius:a.borderRadius,backgroundColor:a.backgroundColor,cursor:a.disabled?"not-allowed":"crosshair",display:"block",width:"100%",height:"100%"})),lt=u.computed(()=>({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#999",fontSize:"14px",pointerEvents:"none",userSelect:"none"})),rt=u.computed(()=>b.value?!1:a.placeholder&&N(r.value)),ie=u.computed(()=>v.value>0),se=u.computed(()=>v.value<m.value.length-1),le=u.computed(()=>b.value&&d.value),W=u.computed(()=>!le.value&&!a.disabled),ht=u.computed(()=>{var e;return le.value&&((e=a.replayOptions)==null?void 0:e.showControls)!==!1}),_=u.computed(()=>{if(a.penStyle){const e=ae(a.penStyle,a.strokeColor);return{strokeColor:e.strokeColor,strokeWidth:a.strokeWidth||e.strokeWidth,smoothing:a.smoothing!==void 0?a.smoothing:e.smoothing,pressure:{enabled:a.pressureSensitive!==void 0?a.pressureSensitive:e.pressure.enabled,min:a.minStrokeWidth||e.pressure.min,max:a.maxStrokeWidth||e.pressure.max},lineCap:e.lineCap,lineJoin:e.lineJoin}}return{strokeColor:a.strokeColor||"#000000",strokeWidth:a.strokeWidth||2,smoothing:a.smoothing!==void 0?a.smoothing:!0,pressure:{enabled:a.pressureSensitive||!1,min:a.minStrokeWidth||1,max:a.maxStrokeWidth||4},lineCap:"round",lineJoin:"round"}}),re=()=>{var e;return((e=s.value)==null?void 0:e.getContext("2d"))||null},J=(e,n)=>{const p=s.value,C=p.getBoundingClientRect(),g=p.width/C.width,y=p.height/C.height;return{x:(e-C.left)*g,y:(n-C.top)*y,time:Date.now()}},he=e=>{if(!W.value)return;h.value=!0;const n=performance.now(),p={...e,time:n};c.value={points:[p],strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,penStyle:a.penStyle,startTime:n,endTime:n,duration:0},l("signature-start")},Y=(e,n,p,C)=>{switch(p){case"pen":return 1;case"brush":if(n){const P=Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2)),S=Math.max(1,(e.time||0)-(n.time||0)),A=P/S,B=Math.max(.1,Math.min(3,100/Math.max(A,1))),kt=e.pressure||.5,wt=.8+Math.random()*.4;return Math.max(1,Math.min(20,C*B*(.3+kt*1.4)*wt))}return C;case"marker":return 12;case"pencil":const g=e.pressure||.5,y=.9+Math.random()*.2;return C*(.7+g*.6)*y;case"ballpoint":const T=e.pressure||.5;return C*(.8+T*.4);default:return C}},X=(e,n,p)=>{var C;if(!(n.length<2))switch(e.strokeStyle=((C=c.value)==null?void 0:C.strokeColor)||_.value.strokeColor,e.lineCap=_.value.lineCap||"round",e.lineJoin=_.value.lineJoin||"round",p){case"pen":if(e.lineWidth=1,e.lineCap="butt",e.lineJoin="miter",e.beginPath(),e.moveTo(n[0].x,n[0].y),n.length>=3){for(let g=1;g<n.length-1;g++){const y=ce(n[g],n[g-1],n[g+1]);e.quadraticCurveTo(y.x,y.y,n[g].x,n[g].y)}e.lineTo(n[n.length-1].x,n[n.length-1].y)}else for(let g=1;g<n.length;g++)e.lineTo(n[g].x,n[g].y);e.stroke();break;case"brush":e.lineCap="round",e.lineJoin="round";for(let g=1;g<n.length;g++){const y=n[g],T=n[g-1],P=Y(y,T,p,_.value.strokeWidth),S=e.createLinearGradient(T.x,T.y,y.x,y.y);S.addColorStop(0,e.strokeStyle),S.addColorStop(1,e.strokeStyle),e.lineWidth=P,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(y.x,y.y),e.stroke(),P>8&&Math.random()>.6&&(e.globalAlpha=.2,e.beginPath(),e.arc(y.x,y.y,P*.3,0,Math.PI*2),e.fill(),e.globalAlpha=1)}break;case"marker":e.globalAlpha=.7,e.lineWidth=12,e.lineCap="square",e.lineJoin="bevel",e.beginPath(),e.moveTo(n[0].x,n[0].y);for(let g=1;g<n.length;g++)e.lineTo(n[g].x,n[g].y);e.stroke(),e.globalAlpha=.3,e.lineWidth=16,e.beginPath(),e.moveTo(n[0].x,n[0].y);for(let g=1;g<n.length;g++)e.lineTo(n[g].x,n[g].y);e.stroke(),e.globalAlpha=1;break;case"pencil":e.lineCap="round",e.lineJoin="round";for(let g=1;g<n.length;g++){const y=n[g],T=n[g-1],P=Y(y,T,p,_.value.strokeWidth);e.lineWidth=P,e.globalAlpha=.8,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(y.x,y.y),e.stroke();for(let S=0;S<3;S++)if(Math.random()>.5){e.globalAlpha=.2,e.lineWidth=P*.3;const A=(Math.random()-.5)*2,B=(Math.random()-.5)*2;e.beginPath(),e.moveTo(T.x+A,T.y+B),e.lineTo(y.x+A,y.y+B),e.stroke()}if(Math.random()>.8){e.globalAlpha=.4;for(let S=0;S<5;S++)e.beginPath(),e.arc(y.x+(Math.random()-.5)*3,y.y+(Math.random()-.5)*3,Math.random()*.8,0,Math.PI*2),e.fill()}}e.globalAlpha=1;break;case"ballpoint":e.lineCap="round",e.lineJoin="round";for(let g=1;g<n.length;g++){const y=n[g],T=n[g-1],P=Y(y,T,p,_.value.strokeWidth);if(Math.random()>.1){if(e.lineWidth=P,e.globalAlpha=Math.random()>.2?1:.7,e.beginPath(),_.value.smoothing&&g<n.length-1){const S=n[g+1],A=ce(y,T,S);e.moveTo(T.x,T.y),e.quadraticCurveTo(A.x,A.y,y.x,y.y)}else e.moveTo(T.x,T.y),e.lineTo(y.x,y.y);e.stroke()}Math.random()>.95&&(e.globalAlpha=.8,e.beginPath(),e.arc(y.x,y.y,P*.8,0,Math.PI*2),e.fill())}e.globalAlpha=1;break}},ct=()=>{if(!c.value||c.value.points.length<2)return;const e=re();if(!e)return;const n=c.value.points,p=n.length,C=a.penStyle||"pen";if(p===2)X(e,n,C);else if(p>=3){const g=n.slice(-3);X(e,g,C)}},ce=(e,n,p)=>{const g={length:Math.sqrt(Math.pow(p.x-n.x,2)+Math.pow(p.y-n.y,2)),angle:Math.atan2(p.y-n.y,p.x-n.x)},y=g.angle+Math.PI,T=g.length*.2;return{x:e.x+Math.cos(y)*T,y:e.y+Math.sin(y)*T,time:e.time||0}},ut=(e,n)=>{if(n.points.length<2)return;const p=n.penStyle||a.penStyle||"pen",C=c.value;c.value=n,X(e,n.points,p),c.value=C},ue=e=>{if(!h.value||!c.value||!W.value)return;const n=performance.now(),p={...e,time:n};c.value.points.push(p),c.value.startTime&&(c.value.endTime=n,c.value.duration=n-c.value.startTime),ct(),pe(),l("signature-drawing",r.value)},de=()=>{if(!(!h.value||!c.value)){if(h.value=!1,c.value.points.length>0){const e=c.value.points[c.value.points.length-1];e.time&&c.value.startTime&&(c.value.endTime=e.time,c.value.duration=e.time-c.value.startTime)}r.value.paths.push(c.value),r.value.isEmpty=!1,r.value.timestamp=Date.now(),F(),I(),c.value=null,l("signature-end",r.value)}},dt=e=>{e.preventDefault();const n=J(e.clientX,e.clientY);he(n)},mt=e=>{if(e.preventDefault(),!h.value)return;const n=J(e.clientX,e.clientY);ue(n)},me=e=>{e.preventDefault(),de()},gt=e=>{if(e.preventDefault(),e.touches.length!==1)return;const n=e.touches[0],p=J(n.clientX,n.clientY);he(p)},pt=e=>{if(e.preventDefault(),e.touches.length!==1||!h.value)return;const n=e.touches[0],p=J(n.clientX,n.clientY);ue(p)},ge=e=>{e.preventDefault(),de()},pe=()=>{r.value.canvasSize={width:D.value,height:M.value},r.value.isEmpty=N(r.value)},F=()=>{m.value=m.value.slice(0,v.value+1),m.value.push(R(r.value)),v.value=m.value.length-1;const e=50;m.value.length>e&&(m.value=m.value.slice(-e),v.value=m.value.length-1)},I=()=>{const e=re();e&&(e.clearRect(0,0,D.value,M.value),a.backgroundColor&&a.backgroundColor!=="transparent"&&(e.fillStyle=a.backgroundColor,e.fillRect(0,0,D.value,M.value)),r.value.paths.forEach(n=>{n.points.length>0&&ut(e,n)}))},$=()=>{if(console.log("初始化回放控制器"),console.log("canvas引用是否存在:",!!s.value),!s.value){console.error("canvas引用不存在，无法初始化回放控制器");return}d.value&&(console.log("销毁现有回放控制器"),d.value.destroy()),console.log("创建新的回放控制器"),d.value=new Z(s.value),console.log("回放控制器创建成功:",!!d.value),d.value.on("replay-start",()=>{x.value="playing",l("replay-start")}),d.value.on("replay-progress",(e,n)=>{k.value=e,O.value=n,l("replay-progress",e,n)}),d.value.on("replay-pause",()=>{x.value="paused",l("replay-pause")}),d.value.on("replay-resume",()=>{x.value="playing",l("replay-resume")}),d.value.on("replay-stop",()=>{x.value="stopped",l("replay-stop")}),d.value.on("replay-complete",()=>{x.value="completed",l("replay-complete")}),d.value.on("replay-path-start",(e,n)=>{l("replay-path-start",e,n)}),d.value.on("replay-path-end",(e,n)=>{l("replay-path-end",e,n)}),d.value.on("replay-speed-change",e=>{l("replay-speed-change",e)})},fe=(e,n)=>{if(d.value||$(),d.value){b.value=!0;const p={...n,drawOptions:_.value,penStyle:a.penStyle};d.value.setReplayData(e,p),console.log("startReplay调用，自动播放:",n==null?void 0:n.autoPlay),(n==null?void 0:n.autoPlay)===!0&&d.value.play()}},ye=e=>{b.value=e,!e&&d.value&&(d.value.stop(),I())},ft=()=>N(r.value)?null:ee(r.value),ve=()=>{console.log("play方法被调用"),console.log("回放控制器是否存在:",!!d.value),d.value||(console.log("回放控制器不存在，尝试初始化"),$()),d.value?(console.log("调用回放控制器的play方法"),d.value.play()):console.error("回放控制器初始化失败，无法播放")},xe=()=>{var e;(e=d.value)==null||e.pause()},Ce=()=>{var e;(e=d.value)==null||e.stop()},Te=e=>{var n;(n=d.value)==null||n.seek(e)},be=e=>{var n;(n=d.value)==null||n.setSpeed(e)},yt=()=>{var e;return((e=d.value)==null?void 0:e.getState())||"idle"},vt=()=>{var e;return((e=d.value)==null?void 0:e.getCurrentTime())||0},L=()=>{var e;return((e=d.value)==null?void 0:e.getTotalDuration())||0},xt=()=>{var e;return((e=d.value)==null?void 0:e.getProgress())||0},ke=e=>{const n=Math.floor(e/1e3),p=Math.floor(n/60),C=n%60;return`${p}:${C.toString().padStart(2,"0")}`},we=()=>{W.value&&(r.value=V(D.value,M.value),I(),F(),l("signature-clear"))},Se=()=>{!ie.value||!W.value||(v.value--,r.value=R(m.value[v.value]),I(),l("signature-undo",r.value))},Me=()=>{!se.value||!W.value||(v.value++,r.value=R(m.value[v.value]),I(),l("signature-redo",r.value))},Pe=e=>{const n=s.value;return Q(n,r.value,e)},De=()=>N(r.value),We=async e=>{if(!W.value)return;const n=s.value;await K(n,e),r.value=V(D.value,M.value),r.value.isEmpty=!1,F()},Ct=()=>R(r.value),Tt=e=>{W.value&&(r.value=R(e),I(),F())},Ee=(e,n)=>{const p=e||D.value,C=n||M.value,g=Pe({format:"png"});u.nextTick(()=>{const y=s.value;y.width=p,y.height=C,De()||We(g),pe()})},bt=()=>{const e=s.value;e.width=D.value,e.height=M.value,r.value=V(D.value,M.value),m.value=[R(r.value)],v.value=0,I()};return u.watch([()=>a.width,()=>a.height],()=>{u.nextTick(()=>{s.value&&Ee()})}),u.watch(()=>a.replayMode,e=>{e!==void 0&&ye(e)}),u.watch(()=>a.replayData,e=>{if(console.log("watch监听到回放数据变化:",e),console.log("当前回放模式:",a.replayMode),console.log("回放控制器是否存在:",!!d.value),e&&a.replayMode)if(d.value||(console.log("回放控制器未初始化，先初始化"),$()),d.value){console.log("开始设置回放数据到控制器");const n={...a.replayOptions,drawOptions:_.value,penStyle:a.penStyle};d.value.setReplayData(e,n),console.log("回放数据已更新:",e)}else console.error("回放控制器初始化失败");else e||console.log("回放数据为空，跳过设置"),a.replayMode||console.log("不在回放模式，跳过设置")},{immediate:!0}),u.onMounted(()=>{u.nextTick(()=>{bt(),$(),a.replayMode&&a.replayData&&fe(a.replayData,a.replayOptions)})}),u.onUnmounted(()=>{d.value&&(d.value.destroy(),d.value=null)}),t({clear:we,undo:Se,redo:Me,save:Pe,isEmpty:De,fromDataURL:We,getSignatureData:Ct,setSignatureData:Tt,resize:Ee,startReplay:fe,getReplayData:ft,setReplayMode:ye,play:ve,pause:xe,stop:Ce,seek:Te,setSpeed:be,getState:yt,getCurrentTime:vt,getTotalDuration:L,getProgress:xt}),(e,n)=>(u.openBlock(),u.createElementBlock("div",{class:"electronic-signature",style:u.normalizeStyle(it.value)},[u.createElementVNode("canvas",{ref_key:"canvasRef",ref:s,width:D.value,height:M.value,style:u.normalizeStyle(st.value),onMousedown:dt,onMousemove:mt,onMouseup:me,onMouseleave:me,onTouchstart:gt,onTouchmove:pt,onTouchend:ge,onTouchcancel:ge},null,44,Ne),rt.value?(u.openBlock(),u.createElementBlock("div",{key:0,class:"signature-placeholder",style:u.normalizeStyle(lt.value)},u.toDisplayString(e.placeholder),5)):u.createCommentVNode("",!0),e.showToolbar?(u.openBlock(),u.createElementBlock("div",Ve,[u.createElementVNode("button",{onClick:we,disabled:!W.value},"清除",8,Je),u.createElementVNode("button",{onClick:Se,disabled:!W.value||!ie.value},"撤销",8,Fe),u.createElementVNode("button",{onClick:Me,disabled:!W.value||!se.value},"重做",8,$e)])):u.createCommentVNode("",!0),ht.value?(u.openBlock(),u.createElementBlock("div",Be,[u.createElementVNode("div",qe,[u.createElementVNode("button",{onClick:n[0]||(n[0]=p=>x.value==="playing"?xe():ve()),disabled:x.value==="idle",class:"replay-btn play-pause-btn"},[x.value==="playing"?(u.openBlock(),u.createElementBlock("span",Ye,"⏸️")):(u.openBlock(),u.createElementBlock("span",Xe,"▶️"))],8,ze),u.createElementVNode("button",{onClick:n[1]||(n[1]=p=>Ce()),disabled:x.value==="idle",class:"replay-btn stop-btn"}," ⏹️ ",8,Le)]),u.createElementVNode("div",He,[u.createElementVNode("input",{type:"range",min:"0",max:L(),value:O.value,onInput:n[2]||(n[2]=p=>Te(Number(p.target.value))),class:"progress-slider",disabled:x.value==="idle"},null,40,Ue),u.createElementVNode("div",je,[u.createElementVNode("span",null,u.toDisplayString(ke(O.value)),1),n[4]||(n[4]=u.createElementVNode("span",null,"/",-1)),u.createElementVNode("span",null,u.toDisplayString(ke(L())),1)])]),u.createElementVNode("div",Ge,[n[6]||(n[6]=u.createElementVNode("label",null,"速度:",-1)),u.createElementVNode("select",{onChange:n[3]||(n[3]=p=>be(Number(p.target.value))),class:"speed-select"},n[5]||(n[5]=[u.createElementVNode("option",{value:"0.5"},"0.5x",-1),u.createElementVNode("option",{value:"1",selected:""},"1x",-1),u.createElementVNode("option",{value:"1.5"},"1.5x",-1),u.createElementVNode("option",{value:"2"},"2x",-1)]),32)])])):u.createCommentVNode("",!0)],4))}}),Pt="",z=((i,t)=>{const o=i.__vccOpts||i;for(const[a,l]of t)o[a]=l;return o})(Qe,[["__scopeId","data-v-37d68792"]]);function ne(){return window.devicePixelRatio||1}function Ke(i){const t=i.getContext("2d"),o=ne(),a=i.clientWidth,l=i.clientHeight;return i.width=a*o,i.height=l*o,t.scale(o,o),i.style.width=a+"px",i.style.height=l+"px",t}function oe(i){if(i.paths.length===0)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let t=1/0,o=1/0,a=-1/0,l=-1/0;return i.paths.forEach(s=>{s.points.forEach(h=>{t=Math.min(t,h.x),o=Math.min(o,h.y),a=Math.max(a,h.x),l=Math.max(l,h.y)})}),{minX:t,minY:o,maxX:a,maxY:l,width:a-t,height:l-o}}function Ze(i,t,o=10){const a=oe(t);if(a.width===0||a.height===0){const r=document.createElement("canvas");return r.width=1,r.height=1,r}const l=document.createElement("canvas"),s=l.getContext("2d"),h=a.width+o*2,c=a.height+o*2;return l.width=h,l.height=c,s.drawImage(i,a.minX-o,a.minY-o,h,c,0,0,h,c),l}function et(i,t,o,a=!0){const l=document.createElement("canvas"),s=l.getContext("2d");let h=t,c=o;if(a){const r=i.width/i.height,m=t/o;r>m?c=t/r:h=o*r}return l.width=h,l.height=c,s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(i,0,0,h,c),l}function tt(i,t,o={}){const{fontSize:a=12,fontFamily:l="Arial",color:s="#999",opacity:h=.5,position:c="bottom-right"}=o,r=document.createElement("canvas"),m=r.getContext("2d");r.width=i.width,r.height=i.height,m.drawImage(i,0,0),m.font=`${a}px ${l}`,m.fillStyle=s,m.globalAlpha=h;const d=m.measureText(t).width,b=a;let x,k;switch(c){case"top-left":x=10,k=b+10;break;case"top-right":x=i.width-d-10,k=b+10;break;case"bottom-left":x=10,k=i.height-10;break;case"bottom-right":x=i.width-d-10,k=i.height-10;break;case"center":x=(i.width-d)/2,k=(i.height+b)/2;break;default:x=i.width-d-10,k=i.height-10}return m.fillText(t,x,k),m.globalAlpha=1,r}function at(i){const t=document.createElement("canvas"),o=t.getContext("2d");t.width=i.width,t.height=i.height,o.drawImage(i,0,0);const a=o.getImageData(0,0,i.width,i.height),l=a.data;for(let s=0;s<l.length;s+=4){const h=l[s]*.299+l[s+1]*.587+l[s+2]*.114;l[s]=h,l[s+1]=h,l[s+2]=h}return o.putImageData(a,0,0),t}const nt={install:i=>{i.component("ElectronicSignature",z)},ElectronicSignature:z},ot="1.0.0";f.ElectronicSignature=z,f.PEN_STYLE_CONFIGS=q,f.SignatureReplayController=Z,f.addWatermark=tt,f.calculateStrokeWidth=j,f.cloneSignatureData=R,f.convertToGrayscale=at,f.createDrawOptionsFromPenStyle=ae,f.createEmptySignatureData=V,f.createReplayData=ee,f.cropSignature=Ze,f.default=nt,f.drawSmoothPath=_e,f.exportSignature=Q,f.getAllPenStyles=Oe,f.getAngle=H,f.getControlPoint=U,f.getDevicePixelRatio=ne,f.getDistance=E,f.getPenStyleConfig=te,f.getSignatureBounds=oe,f.isSignatureEmpty=N,f.loadImageToCanvas=K,f.resizeSignature=et,f.setupHighDPICanvas=Ke,f.signatureToSVG=G,f.version=ot,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

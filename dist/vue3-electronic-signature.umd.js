(function(g,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],l):(g=typeof globalThis<"u"?globalThis:g||self,l(g.Vue3ElectronicSignature={},g.Vue))})(this,function(g,l){"use strict";var pt=Object.defineProperty;var gt=(g,l,D)=>l in g?pt(g,l,{enumerable:!0,configurable:!0,writable:!0,value:D}):g[l]=D;var C=(g,l,D)=>(gt(g,typeof l!="symbol"?l+"":l,D),D);function D(i,e){return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2))}function A(i,e){return Math.atan2(e.y-i.y,e.x-i.x)}function q(i,e,o,a){const n=e||i,c=o||i,u=.2,h=A(n,c)*(a?1:-1),r=D(n,c)*u;return{x:i.x+Math.cos(h)*r,y:i.y+Math.sin(h)*r,time:i.time}}function z(i,e,o){if(!o.pressure.enabled)return o.strokeWidth;const a=D(i,e),n=e.time-i.time,c=n>0?a/n:0,u=Math.max(.1,Math.min(1,1-c*.01)),{min:h,max:r}=o.pressure;return h+(r-h)*u}function Ce(i,e,o){if(e.length<2)return;if(i.strokeStyle=o.strokeColor,i.lineCap="round",i.lineJoin="round",!o.smoothing||e.length<3){i.beginPath(),i.lineWidth=o.strokeWidth,i.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)i.lineTo(e[n].x,e[n].y);i.stroke();return}i.beginPath(),i.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length-1;n++){const c=e[n],u=e[n+1];o.pressure.enabled?i.lineWidth=z(e[n-1],c,o):i.lineWidth=o.strokeWidth;const h=q(c,e[n-1],u);i.quadraticCurveTo(h.x,h.y,c.x,c.y)}const a=e[e.length-1];i.lineTo(a.x,a.y),i.stroke()}function X(i){const{canvasSize:e,paths:o}=i;let a=`<svg width="${e.width}" height="${e.height}" xmlns="http://www.w3.org/2000/svg">`;return o.forEach(n=>{if(n.points.length<2)return;let c=`M ${n.points[0].x} ${n.points[0].y}`;for(let u=1;u<n.points.length;u++)c+=` L ${n.points[u].x} ${n.points[u].y}`;a+=`<path d="${c}" stroke="${n.strokeColor}" stroke-width="${n.strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),a+="</svg>",a}function Y(i,e,o={format:"png"}){const{format:a,quality:n=.9,size:c,backgroundColor:u}=o;if(a==="svg")return X(e);const h=document.createElement("canvas"),r=h.getContext("2d");if(c){h.width=c.width,h.height=c.height;const p=c.width/i.width,y=c.height/i.height;r.scale(p,y)}else h.width=i.width,h.height=i.height;switch(u&&u!=="transparent"&&(r.fillStyle=u,r.fillRect(0,0,h.width,h.height)),r.drawImage(i,0,0),a){case"jpeg":return h.toDataURL("image/jpeg",n);case"base64":return h.toDataURL("image/png").split(",")[1];case"png":default:return h.toDataURL("image/png")}}function F(i,e){return new Promise((o,a)=>{const n=new Image;n.onload=()=>{const c=i.getContext("2d");c.clearRect(0,0,i.width,i.height),c.drawImage(n,0,0,i.width,i.height),o()},n.onerror=a,n.src=e})}function R(i){return i.paths.length===0||i.paths.every(e=>e.points.length===0)}function I(i,e){return{paths:[],canvasSize:{width:i,height:e},timestamp:Date.now(),isEmpty:!0}}function M(i){return JSON.parse(JSON.stringify(i))}class H{constructor(e){C(this,"canvas");C(this,"ctx");C(this,"replayData",null);C(this,"state","idle");C(this,"currentTime",0);C(this,"speed",1);C(this,"animationId",null);C(this,"startTimestamp",0);C(this,"pausedTime",0);C(this,"options",{});C(this,"eventCallbacks",new Map);this.canvas=e,this.ctx=e.getContext("2d")}setReplayData(e,o={}){console.log("设置回放数据:",e),console.log("回放选项:",o),this.replayData=e,this.options={...o},this.speed=o.speed||e.speed||1,this.currentTime=o.startTime||0,this.state="idle",console.log("回放数据设置完成，路径数量:",e.paths.length),console.log("总时长:",e.totalDuration)}play(){if(console.log("播放方法调用，回放数据:",this.replayData),console.log("当前状态:",this.state),!this.replayData){console.error("没有回放数据，无法播放");return}if(this.replayData.totalDuration<=0){console.error("回放数据总时长为0，无法播放");return}if(this.replayData.paths.length===0){console.error("回放数据没有路径，无法播放");return}if(this.state==="playing"){console.log("已在播放中，忽略");return}this.state==="paused"?(console.log("从暂停状态恢复播放"),this.state="playing",this.startTimestamp=performance.now()-this.pausedTime,this.emit("replay-resume")):(console.log("开始新的播放"),this.state="playing",this.startTimestamp=performance.now(),this.pausedTime=0,this.currentTime=this.options.startTime||0,this.clearCanvas(),this.emit("replay-start")),this.animate()}pause(){this.state==="playing"&&(this.state="paused",this.pausedTime=performance.now()-this.startTimestamp,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.emit("replay-pause"))}stop(){this.state="stopped",this.currentTime=0,this.pausedTime=0,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clearCanvas(),this.emit("replay-stop")}seek(e){if(!this.replayData)return;const o=this.options.endTime||this.replayData.totalDuration;this.currentTime=Math.max(0,Math.min(e,o)),this.state==="playing"?this.startTimestamp=performance.now()-this.currentTime/this.speed:this.pausedTime=this.currentTime/this.speed,this.renderFrame(this.currentTime)}setSpeed(e){const o=this.state==="playing";o&&this.pause(),this.speed=Math.max(.1,Math.min(5,e)),this.emit("replay-speed-change",this.speed),o&&this.play()}getState(){return this.state}getCurrentTime(){return this.currentTime}getTotalDuration(){var e;return((e=this.replayData)==null?void 0:e.totalDuration)||0}getProgress(){const e=this.getTotalDuration();return e>0?this.currentTime/e:0}animate(){if(this.state!=="playing"||!this.replayData)return;const e=performance.now();this.currentTime=(e-this.startTimestamp)*this.speed;const o=this.options.endTime||this.replayData.totalDuration;if(this.currentTime>=o){this.currentTime=o,this.state="completed",this.renderFrame(this.currentTime),this.emit("replay-complete"),this.options.loop&&setTimeout(()=>{this.currentTime=this.options.startTime||0,this.play()},500);return}this.renderFrame(this.currentTime),this.emit("replay-progress",this.getProgress(),this.currentTime),this.animationId=requestAnimationFrame(()=>this.animate())}renderFrame(e){if(!this.replayData)return;this.clearCanvas();let o=!1;for(let a=0;a<this.replayData.paths.length;a++){const n=this.replayData.paths[a],c=n.startTime||0,u=n.endTime||c+(n.duration||0);if(e<c)break;if(e>=u){this.drawCompletePath(n),!o&&Math.abs(e-u)<32&&this.emit("replay-path-end",a,n);continue}o=!0;const h=Math.max(0,Math.min(1,(e-c)/Math.max(u-c,1)));h>0&&Math.abs(e-c)<32&&this.emit("replay-path-start",a,n),this.drawPartialPath(n,h);break}}drawCompletePath(e){if(e.points.length<2)return;const o=this.options.drawOptions||{strokeColor:e.strokeColor,strokeWidth:e.strokeWidth,smoothing:!0,pressure:{enabled:!1,min:1,max:4}};this.drawPathWithSmoothAlgorithm(e.points,{...o,strokeColor:e.strokeColor,strokeWidth:e.strokeWidth})}drawPartialPath(e,o){if(e.points.length<2)return;const a=e.startTime||0,n=e.duration||0,c=a+n*o,u=this.getPointsUpToTime(e.points,a,c);if(u.length<2)return;const h=this.options.drawOptions||{strokeColor:e.strokeColor,strokeWidth:e.strokeWidth,smoothing:!0,pressure:{enabled:!1,min:1,max:4}};this.drawPathWithSmoothAlgorithm(u,{...h,strokeColor:e.strokeColor,strokeWidth:e.strokeWidth})}getPointsUpToTime(e,o,a){const n=[];for(let c=0;c<e.length;c++){const u=e[c],h=o+(u.relativeTime||c*50);if(h<=a)n.push(u);else{if(c>0){const r=e[c-1],p=o+(r.relativeTime||(c-1)*50);if(p<=a){const y=(a-p)/(h-p),m={x:r.x+(u.x-r.x)*y,y:r.y+(u.y-r.y)*y,time:a,pressure:r.pressure?r.pressure+(u.pressure||r.pressure-r.pressure)*y:u.pressure};n.push(m)}}break}}return n}drawPathWithSmoothAlgorithm(e,o){if(e.length<2)return;if(this.ctx.strokeStyle=o.strokeColor,this.ctx.lineCap="round",this.ctx.lineJoin="round",!o.smoothing||e.length<3){this.ctx.beginPath(),this.ctx.lineWidth=o.strokeWidth,this.ctx.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)this.ctx.lineTo(e[n].x,e[n].y);this.ctx.stroke();return}this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length-1;n++){const c=e[n],u=e[n+1];this.ctx.lineWidth=o.strokeWidth;const h=this.getControlPoint(c,e[n-1],u);this.ctx.quadraticCurveTo(h.x,h.y,c.x,c.y)}const a=e[e.length-1];this.ctx.lineTo(a.x,a.y),this.ctx.stroke()}getControlPoint(e,o,a){const c={length:Math.sqrt(Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2)),angle:Math.atan2(a.y-o.y,a.x-o.x)},u=c.angle+Math.PI,h=c.length*.2;return{x:e.x+Math.cos(u)*h,y:e.y+Math.sin(u)*h,time:e.time||0}}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}on(e,o){this.eventCallbacks.has(e)||this.eventCallbacks.set(e,[]),this.eventCallbacks.get(e).push(o)}off(e,o){if(this.eventCallbacks.has(e))if(o){const a=this.eventCallbacks.get(e),n=a.indexOf(o);n>-1&&a.splice(n,1)}else this.eventCallbacks.delete(e)}emit(e,...o){const a=this.eventCallbacks.get(e);a&&a.forEach(n=>n(...o))}destroy(){this.stop(),this.eventCallbacks.clear(),this.replayData=null}}function U(i){const e=i.paths.map(r=>{const p=r.points.map((m,k)=>{var x;let v;if(m.time&&r.points[0].time)v=m.time-r.points[0].time;else if(k===0)v=0;else{const _=r.points[k-1],b=Math.sqrt(Math.pow(m.x-_.x,2)+Math.pow(m.y-_.y,2))/100*1e3;v=(((x=p[k-1])==null?void 0:x.relativeTime)||0)+Math.max(b,16)}return{...m,relativeTime:v}}),y=p.length>0?p[p.length-1].relativeTime:0;return{...r,points:p,duration:y}}),o=[];for(let r=0;r<e.length;r++){const p=e[r];let y;if(r===0)y=0;else{const v=o[r-1],x=be(i.paths[r-1].points,i.paths[r].points);y=v.endTime+x}const m=y+p.duration,k={...p,startTime:y,endTime:m};console.log(`路径 ${r}: 开始时间=${y}, 结束时间=${m}, 持续时间=${p.duration}`),o.push(k)}const a=o.length>0?o[o.length-1].endTime:0;console.log("回放数据生成完成:"),console.log("- 路径数量:",o.length),console.log("- 总时长:",a),console.log("- 路径详情:",o.map(r=>({startTime:r.startTime,endTime:r.endTime,duration:r.duration,pointCount:r.points.length})));const n=o.reduce((r,p)=>r+Se(p.points),0),c=a>0?n/(a/1e3):0,u=o.slice(1).map((r,p)=>{const y=o[p];return r.startTime-y.endTime}),h=u.length>0?u.reduce((r,p)=>r+p,0)/u.length:0;return{paths:o,totalDuration:a,speed:1,metadata:{deviceType:Pe(i),averageSpeed:c,totalDistance:n,averagePauseTime:h}}}function be(i,e){if(i.length===0||e.length===0)return 200;const o=i[i.length-1],a=e[0];if(o.time&&a.time)return Math.max(a.time-o.time,50);const n=Math.sqrt(Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2));return Math.min(Math.max(n*2,100),1e3)}function Pe(i){const e=i.paths.reduce((c,u)=>c+u.points.length,0),o=i.paths.length;if(e===0)return"touch";const a=e/o;return a>20?"touch":a<10?"mouse":i.paths.some(c=>c.points.some(u=>u.pressure!==void 0))?"pen":"touch"}function Se(i){let e=0;for(let o=1;o<i.length;o++){const a=i[o].x-i[o-1].x,n=i[o].y-i[o-1].y;e+=Math.sqrt(a*a+n*n)}return e}const De=["width","height"],Me={key:1,class:"signature-toolbar"},Ee=["disabled"],We=["disabled"],_e=["disabled"],Re={key:2,class:"replay-controls"},Ie={class:"replay-buttons"},Ne=["disabled"],Ve={key:0},$e={key:1},Be=["disabled"],Oe={class:"replay-progress"},Ae=["max","value","disabled"],qe={class:"time-display"},ze={class:"replay-speed"},Xe=l.defineComponent({__name:"ElectronicSignature",props:{showToolbar:{type:Boolean,default:!1},width:{default:"100%"},height:{default:300},strokeColor:{default:"#000000"},strokeWidth:{default:2},backgroundColor:{default:"transparent"},disabled:{type:Boolean,default:!1},placeholder:{default:"请在此处签名"},smoothing:{type:Boolean,default:!0},pressureSensitive:{type:Boolean,default:!1},minStrokeWidth:{default:1},maxStrokeWidth:{default:4},borderStyle:{default:"1px solid #ddd"},borderRadius:{default:"4px"},replayMode:{type:Boolean},replayData:{},replayOptions:{}},emits:["signature-start","signature-drawing","signature-end","signature-clear","signature-undo","signature-redo","replay-start","replay-progress","replay-pause","replay-resume","replay-stop","replay-complete","replay-path-start","replay-path-end","replay-speed-change"],setup(i,{expose:e,emit:o}){const a=i,n=o,c=l.ref(),u=l.ref(!1),h=l.ref(null),r=l.ref(I(0,0)),p=l.ref([]),y=l.ref(-1),m=l.ref(null),k=l.ref(!1),v=l.ref("idle"),x=l.ref(0),_=l.ref(0),P=l.computed(()=>typeof a.width=="number"?a.width:800),b=l.computed(()=>typeof a.height=="number"?a.height:300),Ge=l.computed(()=>({position:"relative",display:"inline-block",width:typeof a.width=="string"?a.width:`${a.width}px`,height:typeof a.height=="string"?a.height:`${a.height}px`})),Qe=l.computed(()=>({border:a.borderStyle,borderRadius:a.borderRadius,backgroundColor:a.backgroundColor,cursor:a.disabled?"not-allowed":"crosshair",display:"block",width:"100%",height:"100%"})),Ke=l.computed(()=>({position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#999",fontSize:"14px",pointerEvents:"none",userSelect:"none"})),Ze=l.computed(()=>k.value?!1:a.placeholder&&R(r.value)),j=l.computed(()=>y.value>0),G=l.computed(()=>y.value<p.value.length-1),Q=l.computed(()=>k.value&&m.value),S=l.computed(()=>!Q.value&&!a.disabled),et=l.computed(()=>{var t;return Q.value&&((t=a.replayOptions)==null?void 0:t.showControls)!==!1}),K=l.computed(()=>({strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,smoothing:a.smoothing,pressure:{enabled:a.pressureSensitive,min:a.minStrokeWidth,max:a.maxStrokeWidth}})),Z=()=>{var t;return((t=c.value)==null?void 0:t.getContext("2d"))||null},N=(t,s)=>{const d=c.value,f=d.getBoundingClientRect(),T=d.width/f.width,w=d.height/f.height;return{x:(t-f.left)*T,y:(s-f.top)*w,time:Date.now()}},ee=t=>{if(!S.value)return;u.value=!0;const s=performance.now(),d={...t,time:s};h.value={points:[d],strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,startTime:s,endTime:s,duration:0},n("signature-start")},tt=()=>{if(!h.value||h.value.points.length<2)return;const t=Z();if(!t)return;const s=h.value.points,d=s.length;if(t.strokeStyle=h.value.strokeColor,t.lineWidth=h.value.strokeWidth,t.lineCap="round",t.lineJoin="round",d===2)t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.stroke();else if(d>=3){const f=s[d-3],T=s[d-2],w=s[d-1];if(t.beginPath(),a.smoothing){t.moveTo(f.x,f.y);const W=te(T,f,w);t.quadraticCurveTo(W.x,W.y,T.x,T.y)}else t.moveTo(T.x,T.y),t.lineTo(w.x,w.y);t.stroke()}},te=(t,s,d)=>{const T={length:Math.sqrt(Math.pow(d.x-s.x,2)+Math.pow(d.y-s.y,2)),angle:Math.atan2(d.y-s.y,d.x-s.x)},w=T.angle+Math.PI,W=T.length*.2;return{x:t.x+Math.cos(w)*W,y:t.y+Math.sin(w)*W,time:t.time||0}},at=(t,s)=>{if(s.points.length<2)return;t.strokeStyle=s.strokeColor,t.lineWidth=s.strokeWidth,t.lineCap="round",t.lineJoin="round";const d=s.points;if(d.length===2){t.beginPath(),t.moveTo(d[0].x,d[0].y),t.lineTo(d[1].x,d[1].y),t.stroke();return}if(!a.smoothing){t.beginPath(),t.moveTo(d[0].x,d[0].y);for(let f=1;f<d.length;f++)t.lineTo(d[f].x,d[f].y);t.stroke();return}t.beginPath(),t.moveTo(d[0].x,d[0].y),d.length>=3&&t.lineTo(d[1].x,d[1].y);for(let f=1;f<d.length-1;f++){const T=d[f-1],w=d[f],W=d[f+1],xe=te(w,T,W);t.quadraticCurveTo(xe.x,xe.y,w.x,w.y)}if(d.length>=3){const f=d[d.length-1],T=d[d.length-2];t.quadraticCurveTo(T.x,T.y,f.x,f.y)}t.stroke()},ae=t=>{if(!u.value||!h.value||!S.value)return;const s=performance.now(),d={...t,time:s};h.value.points.push(d),h.value.startTime&&(h.value.endTime=s,h.value.duration=s-h.value.startTime),tt(),se(),n("signature-drawing",r.value)},ne=()=>{if(!(!u.value||!h.value)){if(u.value=!1,h.value.points.length>0){const t=h.value.points[h.value.points.length-1];t.time&&h.value.startTime&&(h.value.endTime=t.time,h.value.duration=t.time-h.value.startTime)}r.value.paths.push(h.value),r.value.isEmpty=!1,r.value.timestamp=Date.now(),V(),E(),h.value=null,n("signature-end",r.value)}},nt=t=>{t.preventDefault();const s=N(t.clientX,t.clientY);ee(s)},ot=t=>{if(t.preventDefault(),!u.value)return;const s=N(t.clientX,t.clientY);ae(s)},oe=t=>{t.preventDefault(),ne()},it=t=>{if(t.preventDefault(),t.touches.length!==1)return;const s=t.touches[0],d=N(s.clientX,s.clientY);ee(d)},st=t=>{if(t.preventDefault(),t.touches.length!==1||!u.value)return;const s=t.touches[0],d=N(s.clientX,s.clientY);ae(d)},ie=t=>{t.preventDefault(),ne()},se=()=>{r.value.canvasSize={width:P.value,height:b.value},r.value.isEmpty=R(r.value)},V=()=>{p.value=p.value.slice(0,y.value+1),p.value.push(M(r.value)),y.value=p.value.length-1;const t=50;p.value.length>t&&(p.value=p.value.slice(-t),y.value=p.value.length-1)},E=()=>{const t=Z();t&&(t.clearRect(0,0,P.value,b.value),a.backgroundColor&&a.backgroundColor!=="transparent"&&(t.fillStyle=a.backgroundColor,t.fillRect(0,0,P.value,b.value)),r.value.paths.forEach(s=>{s.points.length>0&&at(t,s)}))},$=()=>{if(console.log("初始化回放控制器"),console.log("canvas引用是否存在:",!!c.value),!c.value){console.error("canvas引用不存在，无法初始化回放控制器");return}m.value&&(console.log("销毁现有回放控制器"),m.value.destroy()),console.log("创建新的回放控制器"),m.value=new H(c.value),console.log("回放控制器创建成功:",!!m.value),m.value.on("replay-start",()=>{v.value="playing",n("replay-start")}),m.value.on("replay-progress",(t,s)=>{x.value=t,_.value=s,n("replay-progress",t,s)}),m.value.on("replay-pause",()=>{v.value="paused",n("replay-pause")}),m.value.on("replay-resume",()=>{v.value="playing",n("replay-resume")}),m.value.on("replay-stop",()=>{v.value="stopped",n("replay-stop")}),m.value.on("replay-complete",()=>{v.value="completed",n("replay-complete")}),m.value.on("replay-path-start",(t,s)=>{n("replay-path-start",t,s)}),m.value.on("replay-path-end",(t,s)=>{n("replay-path-end",t,s)}),m.value.on("replay-speed-change",t=>{n("replay-speed-change",t)})},le=(t,s)=>{if(m.value||$(),m.value){k.value=!0;const d={...s,drawOptions:K.value};m.value.setReplayData(t,d),console.log("startReplay调用，自动播放:",s==null?void 0:s.autoPlay),(s==null?void 0:s.autoPlay)===!0&&m.value.play()}},re=t=>{k.value=t,!t&&m.value&&(m.value.stop(),E())},lt=()=>R(r.value)?null:U(r.value),ce=()=>{console.log("play方法被调用"),console.log("回放控制器是否存在:",!!m.value),m.value||(console.log("回放控制器不存在，尝试初始化"),$()),m.value?(console.log("调用回放控制器的play方法"),m.value.play()):console.error("回放控制器初始化失败，无法播放")},he=()=>{var t;(t=m.value)==null||t.pause()},ue=()=>{var t;(t=m.value)==null||t.stop()},de=t=>{var s;(s=m.value)==null||s.seek(t)},me=t=>{var s;(s=m.value)==null||s.setSpeed(t)},rt=()=>{var t;return((t=m.value)==null?void 0:t.getState())||"idle"},ct=()=>{var t;return((t=m.value)==null?void 0:t.getCurrentTime())||0},O=()=>{var t;return((t=m.value)==null?void 0:t.getTotalDuration())||0},ht=()=>{var t;return((t=m.value)==null?void 0:t.getProgress())||0},pe=t=>{const s=Math.floor(t/1e3),d=Math.floor(s/60),f=s%60;return`${d}:${f.toString().padStart(2,"0")}`},ge=()=>{S.value&&(r.value=I(P.value,b.value),E(),V(),n("signature-clear"))},ye=()=>{!j.value||!S.value||(y.value--,r.value=M(p.value[y.value]),E(),n("signature-undo",r.value))},fe=()=>{!G.value||!S.value||(y.value++,r.value=M(p.value[y.value]),E(),n("signature-redo",r.value))},ve=t=>{const s=c.value;return Y(s,r.value,t)},Te=()=>R(r.value),we=async t=>{if(!S.value)return;const s=c.value;await F(s,t),r.value=I(P.value,b.value),r.value.isEmpty=!1,V()},ut=()=>M(r.value),dt=t=>{S.value&&(r.value=M(t),E(),V())},ke=(t,s)=>{const d=t||P.value,f=s||b.value,T=ve({format:"png"});l.nextTick(()=>{const w=c.value;w.width=d,w.height=f,Te()||we(T),se()})},mt=()=>{const t=c.value;t.width=P.value,t.height=b.value,r.value=I(P.value,b.value),p.value=[M(r.value)],y.value=0,E()};return l.watch([()=>a.width,()=>a.height],()=>{l.nextTick(()=>{c.value&&ke()})}),l.watch(()=>a.replayMode,t=>{t!==void 0&&re(t)}),l.watch(()=>a.replayData,t=>{if(console.log("watch监听到回放数据变化:",t),console.log("当前回放模式:",a.replayMode),console.log("回放控制器是否存在:",!!m.value),t&&a.replayMode)if(m.value||(console.log("回放控制器未初始化，先初始化"),$()),m.value){console.log("开始设置回放数据到控制器");const s={...a.replayOptions,drawOptions:K.value};m.value.setReplayData(t,s),console.log("回放数据已更新:",t)}else console.error("回放控制器初始化失败");else t||console.log("回放数据为空，跳过设置"),a.replayMode||console.log("不在回放模式，跳过设置")},{immediate:!0}),l.onMounted(()=>{l.nextTick(()=>{mt(),$(),a.replayMode&&a.replayData&&le(a.replayData,a.replayOptions)})}),l.onUnmounted(()=>{m.value&&(m.value.destroy(),m.value=null)}),e({clear:ge,undo:ye,redo:fe,save:ve,isEmpty:Te,fromDataURL:we,getSignatureData:ut,setSignatureData:dt,resize:ke,startReplay:le,getReplayData:lt,setReplayMode:re,play:ce,pause:he,stop:ue,seek:de,setSpeed:me,getState:rt,getCurrentTime:ct,getTotalDuration:O,getProgress:ht}),(t,s)=>(l.openBlock(),l.createElementBlock("div",{class:"electronic-signature",style:l.normalizeStyle(Ge.value)},[l.createElementVNode("canvas",{ref_key:"canvasRef",ref:c,width:P.value,height:b.value,style:l.normalizeStyle(Qe.value),onMousedown:nt,onMousemove:ot,onMouseup:oe,onMouseleave:oe,onTouchstart:it,onTouchmove:st,onTouchend:ie,onTouchcancel:ie},null,44,De),Ze.value?(l.openBlock(),l.createElementBlock("div",{key:0,class:"signature-placeholder",style:l.normalizeStyle(Ke.value)},l.toDisplayString(t.placeholder),5)):l.createCommentVNode("",!0),t.showToolbar?(l.openBlock(),l.createElementBlock("div",Me,[l.createElementVNode("button",{onClick:ge,disabled:!S.value},"清除",8,Ee),l.createElementVNode("button",{onClick:ye,disabled:!S.value||!j.value},"撤销",8,We),l.createElementVNode("button",{onClick:fe,disabled:!S.value||!G.value},"重做",8,_e)])):l.createCommentVNode("",!0),et.value?(l.openBlock(),l.createElementBlock("div",Re,[l.createElementVNode("div",Ie,[l.createElementVNode("button",{onClick:s[0]||(s[0]=d=>v.value==="playing"?he():ce()),disabled:v.value==="idle",class:"replay-btn play-pause-btn"},[v.value==="playing"?(l.openBlock(),l.createElementBlock("span",Ve,"⏸️")):(l.openBlock(),l.createElementBlock("span",$e,"▶️"))],8,Ne),l.createElementVNode("button",{onClick:s[1]||(s[1]=d=>ue()),disabled:v.value==="idle",class:"replay-btn stop-btn"}," ⏹️ ",8,Be)]),l.createElementVNode("div",Oe,[l.createElementVNode("input",{type:"range",min:"0",max:O(),value:_.value,onInput:s[2]||(s[2]=d=>de(Number(d.target.value))),class:"progress-slider",disabled:v.value==="idle"},null,40,Ae),l.createElementVNode("div",qe,[l.createElementVNode("span",null,l.toDisplayString(pe(_.value)),1),s[4]||(s[4]=l.createElementVNode("span",null,"/",-1)),l.createElementVNode("span",null,l.toDisplayString(pe(O())),1)])]),l.createElementVNode("div",ze,[s[6]||(s[6]=l.createElementVNode("label",null,"速度:",-1)),l.createElementVNode("select",{onChange:s[3]||(s[3]=d=>me(Number(d.target.value))),class:"speed-select"},s[5]||(s[5]=[l.createElementVNode("option",{value:"0.5"},"0.5x",-1),l.createElementVNode("option",{value:"1",selected:""},"1x",-1),l.createElementVNode("option",{value:"1.5"},"1.5x",-1),l.createElementVNode("option",{value:"2"},"2x",-1)]),32)])])):l.createCommentVNode("",!0)],4))}}),yt="",B=((i,e)=>{const o=i.__vccOpts||i;for(const[a,n]of e)o[a]=n;return o})(Xe,[["__scopeId","data-v-81a2b7c2"]]);function L(){return window.devicePixelRatio||1}function Ye(i){const e=i.getContext("2d"),o=L(),a=i.clientWidth,n=i.clientHeight;return i.width=a*o,i.height=n*o,e.scale(o,o),i.style.width=a+"px",i.style.height=n+"px",e}function J(i){if(i.paths.length===0)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let e=1/0,o=1/0,a=-1/0,n=-1/0;return i.paths.forEach(c=>{c.points.forEach(u=>{e=Math.min(e,u.x),o=Math.min(o,u.y),a=Math.max(a,u.x),n=Math.max(n,u.y)})}),{minX:e,minY:o,maxX:a,maxY:n,width:a-e,height:n-o}}function Fe(i,e,o=10){const a=J(e);if(a.width===0||a.height===0){const r=document.createElement("canvas");return r.width=1,r.height=1,r}const n=document.createElement("canvas"),c=n.getContext("2d"),u=a.width+o*2,h=a.height+o*2;return n.width=u,n.height=h,c.drawImage(i,a.minX-o,a.minY-o,u,h,0,0,u,h),n}function He(i,e,o,a=!0){const n=document.createElement("canvas"),c=n.getContext("2d");let u=e,h=o;if(a){const r=i.width/i.height,p=e/o;r>p?h=e/r:u=o*r}return n.width=u,n.height=h,c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.drawImage(i,0,0,u,h),n}function Ue(i,e,o={}){const{fontSize:a=12,fontFamily:n="Arial",color:c="#999",opacity:u=.5,position:h="bottom-right"}=o,r=document.createElement("canvas"),p=r.getContext("2d");r.width=i.width,r.height=i.height,p.drawImage(i,0,0),p.font=`${a}px ${n}`,p.fillStyle=c,p.globalAlpha=u;const m=p.measureText(e).width,k=a;let v,x;switch(h){case"top-left":v=10,x=k+10;break;case"top-right":v=i.width-m-10,x=k+10;break;case"bottom-left":v=10,x=i.height-10;break;case"bottom-right":v=i.width-m-10,x=i.height-10;break;case"center":v=(i.width-m)/2,x=(i.height+k)/2;break;default:v=i.width-m-10,x=i.height-10}return p.fillText(e,v,x),p.globalAlpha=1,r}function Le(i){const e=document.createElement("canvas"),o=e.getContext("2d");e.width=i.width,e.height=i.height,o.drawImage(i,0,0);const a=o.getImageData(0,0,i.width,i.height),n=a.data;for(let c=0;c<n.length;c+=4){const u=n[c]*.299+n[c+1]*.587+n[c+2]*.114;n[c]=u,n[c+1]=u,n[c+2]=u}return o.putImageData(a,0,0),e}const Je={install:i=>{i.component("ElectronicSignature",B)},ElectronicSignature:B},je="1.0.0";g.ElectronicSignature=B,g.SignatureReplayController=H,g.addWatermark=Ue,g.calculateStrokeWidth=z,g.cloneSignatureData=M,g.convertToGrayscale=Le,g.createEmptySignatureData=I,g.createReplayData=U,g.cropSignature=Fe,g.default=Je,g.drawSmoothPath=Ce,g.exportSignature=Y,g.getAngle=A,g.getControlPoint=q,g.getDevicePixelRatio=L,g.getDistance=D,g.getSignatureBounds=J,g.isSignatureEmpty=R,g.loadImageToCanvas=F,g.resizeSignature=He,g.setupHighDPICanvas=Ye,g.signatureToSVG=X,g.version=je,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
